<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff | OnlyyğŸ¦„</title><meta name="author" content="ChrisLeyâ„ï¸"><meta name="copyright" content="ChrisLeyâ„ï¸"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ç†æ¸…äº†createAppèµ°çš„æµç¨‹ï¼Œæœ€åé€šè¿‡createAppAPIåˆ›å»ºäº†appã€‚è™½ç„¶appä¸Šçš„å„ç§å±æ€§å’Œæ–¹æ³•ä¹Ÿéƒ½å·²ç»æœ‰æ‰€äº†è§£ï¼Œä½†å…¶ä¸­çš„mountå’Œunmountæ–¹æ³•ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨renderå‡½æ•°æ¥å®Œæˆçš„ã€‚å°½ç®¡æˆ‘ä»¬å¾ˆå¥½å¥‡renderå‡½æ•°çš„æ•…äº‹ï¼Œå¯æ˜¯baseCreateRendererå‡½æ•°æœ‰2000+è¡Œï¼ŒåŸºæœ¬éƒ½å’Œrenderç›¸å…³ï¼Œå› æ­¤æ‹†è§£åˆ°æœ¬æ–‡é‡Œå™è¿°ï¼Œä»¥ä¸‹æ–¹æ³•éƒ½å®šä¹‰åœ¨baseCreate">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff">
<meta property="og:url" content="https://loveyy520.github.io/onlyy-blog/articals/876e332/">
<meta property="og:site_name" content="OnlyyğŸ¦„">
<meta property="og:description" content="ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ç†æ¸…äº†createAppèµ°çš„æµç¨‹ï¼Œæœ€åé€šè¿‡createAppAPIåˆ›å»ºäº†appã€‚è™½ç„¶appä¸Šçš„å„ç§å±æ€§å’Œæ–¹æ³•ä¹Ÿéƒ½å·²ç»æœ‰æ‰€äº†è§£ï¼Œä½†å…¶ä¸­çš„mountå’Œunmountæ–¹æ³•ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨renderå‡½æ•°æ¥å®Œæˆçš„ã€‚å°½ç®¡æˆ‘ä»¬å¾ˆå¥½å¥‡renderå‡½æ•°çš„æ•…äº‹ï¼Œå¯æ˜¯baseCreateRendererå‡½æ•°æœ‰2000+è¡Œï¼ŒåŸºæœ¬éƒ½å’Œrenderç›¸å…³ï¼Œå› æ­¤æ‹†è§£åˆ°æœ¬æ–‡é‡Œå™è¿°ï¼Œä»¥ä¸‹æ–¹æ³•éƒ½å®šä¹‰åœ¨baseCreate">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png">
<meta property="article:published_time" content="2022-11-02T09:21:00.000Z">
<meta property="article:modified_time" content="2022-11-02T09:21:00.000Z">
<meta property="article:author" content="ChrisLeyâ„ï¸">
<meta property="article:tag" content="å‰ç«¯">
<meta property="article:tag" content="Vue3">
<meta property="article:tag" content="æºç é˜…è¯»">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png"><link rel="shortcut icon" href="https://loveyy520.github.io/onlyy-blog/img/favicon.ico"><link rel="canonical" href="https://loveyy520.github.io/onlyy-blog/articals/876e332/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="https://blog.onlyy.vip/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"è¿™ç¯‡æ–‡ç« æ›´æ–°äº","messageNext":"å¤©ä¹‹å‰ï¼Œå†…å®¹å¯èƒ½æœ‰ç‚¹æ—§äº†å“¦ã€‚"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":50},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":50,"languages":{"author":"ä½œè€…: ChrisLeyâ„ï¸","link":"é“¾æ¥: ","source":"æ¥æº: OnlyyğŸ¦„","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-02 17:21:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://loveyy520.github.io/onlyy-assets/styles/onlyy-blog/custom.css"><meta name="baidu-site-verification" content="code-uOiahucCVX" /><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://loveyy520.github.io/onlyy-assets/styles/onlyy-blog/footerTimer.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word" style="position: absolute;"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://assets.onlyy.vip/icons/dst/Willow.png" onerror="onerror=null;src='https://blog.onlyy.vip/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/articals/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">28</div></a><a href="/articals/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/articals/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon fas fa-tasks" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-shouye-01"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> é¦– é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ–‡ ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/articals/categories/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-fenlei2"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> åˆ† ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/articals/archives/"><svg class="icon fas fa-archives" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guidang"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ—¶ å…‰ æœº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/articals/tags/"><svg class="icon fas fa-tags" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-biaoqian"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ ‡ ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-yule"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ä¼‘ é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/relax/music/"><svg class="icon fa fa-camera" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-yinle"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> éŸ³ ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/movies/"><svg class="icon fas fa-video" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> å½± è§†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/games/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-youxi"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ¸¸ æˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/photos/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> çºªå¿µå†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-kongjian1"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç©º é—´</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/zone/love-story/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanai-aixin"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> LoveStory</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/zone/work-life/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-shenghuo"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> Work&amp;Life</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-deng"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ¨ è</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/recommend/movies/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> å½± è§†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/recommend/books/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ä¹¦ ç±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="icon fas fa-envelope" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-xiangsufeng_xinfeng"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç•™ è¨€ æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanyuwomen"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç¤¾ äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="icon fas fa-link" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-lianjie"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> Friends</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanyu"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> About</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">OnlyyğŸ¦„</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon fas fa-tasks" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-shouye-01"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> é¦– é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ–‡ ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/articals/categories/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-fenlei2"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> åˆ† ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/articals/archives/"><svg class="icon fas fa-archives" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guidang"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ—¶ å…‰ æœº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/articals/tags/"><svg class="icon fas fa-tags" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-biaoqian"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ ‡ ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-yule"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ä¼‘ é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/relax/music/"><svg class="icon fa fa-camera" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-yinle"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> éŸ³ ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/movies/"><svg class="icon fas fa-video" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> å½± è§†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/games/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-youxi"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ¸¸ æˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/relax/photos/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> çºªå¿µå†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-kongjian1"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç©º é—´</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/zone/love-story/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanai-aixin"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> LoveStory</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/zone/work-life/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-shenghuo"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> Work&amp;Life</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-deng"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> æ¨ è</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/recommend/movies/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-dianying"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> å½± è§†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/recommend/books/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ä¹¦ ç±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="icon fas fa-envelope" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-xiangsufeng_xinfeng"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç•™ è¨€ æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanyuwomen"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> ç¤¾ äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="icon fas fa-link" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-lianjie"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> Friends</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true" style="font-size: 1.2em;"><use xlink:href="#icon-guanyu"></use></svg><span style="font-size: 1em; font-weight: bold; text-shadow: #c909f1 0 0 3px;"> About</span></a></li></ul></div></div></div><div id="nav-right"><div id="search-button" style="margin-right: 1em;"><a class="site-page social-icon search"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></a></div><div id="darkmode-button" style="margin-right: 1em;" title="åˆ‡æ¢å¤œé—´æ¨¡å¼"><a class="darkmode switch"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ClearNight-qing-yewan"></use></svg></a></div><div id="toggle-menu"><a class="site-page"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidanpeizhi"></use></svg></a></div></div></nav><div id="post-info"><h1 class="post-title">Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-11-02T09:21:00.000Z" title="å‘è¡¨äº 2022-11-02 17:21:00">2022-11-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-11-02T09:21:00.000Z" title="æ›´æ–°äº 2022-11-02 17:21:00">2022-11-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/articals/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/articals/categories/%E6%BA%90%E7%A0%81/">æºç </a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/articals/categories/%E5%89%8D%E7%AB%AF/Vue3/">Vue3</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">10.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>50åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/articals/876e332/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ç†æ¸…äº†<code>createApp</code>èµ°çš„æµç¨‹ï¼Œæœ€åé€šè¿‡<code>createAppAPI</code>åˆ›å»ºäº†<code>app</code>ã€‚è™½ç„¶<code>app</code>ä¸Šçš„å„ç§å±æ€§å’Œæ–¹æ³•ä¹Ÿéƒ½å·²ç»æœ‰æ‰€äº†è§£ï¼Œä½†å…¶ä¸­çš„<code>mount</code>å’Œ<code>unmount</code>æ–¹æ³•ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>render</code>å‡½æ•°æ¥å®Œæˆçš„ã€‚å°½ç®¡æˆ‘ä»¬å¾ˆå¥½å¥‡<code>render</code>å‡½æ•°çš„æ•…äº‹ï¼Œå¯æ˜¯<code>baseCreateRenderer</code>å‡½æ•°æœ‰<code>2000+</code>è¡Œï¼ŒåŸºæœ¬éƒ½å’Œ<code>render</code>ç›¸å…³ï¼Œå› æ­¤æ‹†è§£åˆ°æœ¬æ–‡é‡Œå™è¿°ï¼Œä»¥ä¸‹æ–¹æ³•éƒ½å®šä¹‰åœ¨<code>baseCreateRenderer</code>å‡½æ•°ä¸­ã€‚</p>
<h2 id="ä¸€ã€render"><a href="#ä¸€ã€render" class="headerlink" title="ä¸€ã€render"></a>ä¸€ã€<code>render</code></h2><p><code>render</code>ä¹Ÿä¸ç¥ç§˜äº†ï¼Œæ¯•ç«Ÿåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­éœ²è¿‡é¢ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿé¡ºå¸¦æä¸€ä¸‹ <code>baseCreateRenderer</code>ä»å‚æ•°<code>options</code>ä¸­è§£æ„çš„ä¸€äº›æ–¹æ³•ï¼ŒåŸºæœ¬éƒ½æ˜¯äº›å¢åˆ æ”¹æŸ¥ã€å¤åˆ¶èŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œè§åçŸ¥ä¹‰äº†ã€‚ä¸»è¦çœ‹çœ‹<code>render</code>ï¼Œæ¥æ”¶<code>vnode</code>ã€<code>container</code>ã€<code>isSvg</code>ä¸‰ä¸ªå‚æ•°ã€‚è°ƒç”¨<code>unmount</code>å¸è½½æˆ–è€…è°ƒç”¨<code>patch</code>è¿›è¡ŒèŠ‚ç‚¹æ¯”è¾ƒä»è€Œç»§ç»­ä¸‹ä¸€æ­¥ã€‚</p>
<ul>
<li>åˆ¤æ–­<code>vnode</code>æ˜¯å¦ä¸º<code>null</code>ã€‚å¦‚æœå¯¹ä¸Šä¸€ç¯‡æ–‡ç« è¿˜æœ‰å°è±¡ï¼Œé‚£ä¹ˆå°±ä¼šçŸ¥é“ï¼Œç›¸å½“äºæ˜¯åˆ¤æ–­è°ƒç”¨çš„æ˜¯<code>app.mount</code>è¿˜æ˜¯<code>app.unmount</code>æ–¹æ³•ï¼Œå› ä¸º<code>app.unmount</code>æ–¹æ³•ä¼ å…¥çš„<code>vnode</code>å°±æ˜¯<code>null</code>ã€‚é‚£ä¹ˆè¿™é‡Œå¯¹åº”çš„å°±æ˜¯åœ¨<code>app.unmount</code>é‡Œä½¿ç”¨<code>unmount</code>å‡½æ•°æ¥å¸è½½ï¼›è€Œåœ¨<code>app.mount</code>é‡Œè¿›è¡Œ<code>patch</code>æ¯”è¾ƒã€‚</li>
<li>è°ƒç”¨<code>flushPostFlushCbs()</code>ï¼Œå…¶ä¸­çš„å•è¯<code>Post</code>çš„å«ä¹‰ï¼Œçœ‹è¿‡ç¬¬ä¸€ç¯‡è®²è§£<code>watch</code>çš„åŒå­¦ä¹Ÿè®¸èƒ½çŒœå‡ºæ¥ï¼Œè¡¨ç¤ºæ‰§è¡Œæ—¶æœºæ˜¯åœ¨ç»„ä»¶æ›´æ–°åã€‚è¿™ä¸ªå‡½æ•°ä¾¿æ˜¯æ‰§è¡Œç»„ä»¶æ›´æ–°åçš„ä¸€äº›å›è°ƒã€‚</li>
<li>æŠŠ<code>vnode</code>æŒ‚åˆ°<code>container</code>ä¸Šï¼Œå³æ—§çš„è™šæ‹Ÿ<code>DOM</code>ã€‚</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="attr">insert</span>: hostInsert,</span><br><span class="line">  <span class="attr">remove</span>: hostRemove,</span><br><span class="line">  <span class="attr">patchProp</span>: hostPatchProp,</span><br><span class="line">  <span class="attr">createElement</span>: hostCreateElement,</span><br><span class="line">  <span class="attr">createText</span>: hostCreateText,</span><br><span class="line">  <span class="attr">createComment</span>: hostCreateComment,</span><br><span class="line">  <span class="attr">setText</span>: hostSetText,</span><br><span class="line">  <span class="attr">setElementText</span>: hostSetElementText,</span><br><span class="line">  <span class="attr">parentNode</span>: hostParentNode,</span><br><span class="line">  <span class="attr">nextSibling</span>: hostNextSibling,</span><br><span class="line">  <span class="attr">setScopeId</span>: hostSetScopeId = <span class="variable constant_">NOOP</span>,</span><br><span class="line">  <span class="attr">cloneNode</span>: hostCloneNode,</span><br><span class="line">  <span class="attr">insertStaticContent</span>: hostInsertStaticContent,</span><br><span class="line">&#125; = options;</span><br><span class="line"></span><br><span class="line"><span class="comment">// render</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">render</span>: <span class="title class_">RootRenderFunction</span> = <span class="function">(<span class="params">vnode, container, isSVG</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (container.<span class="property">_vnode</span>) &#123;</span><br><span class="line">      <span class="title function_">unmount</span>(container.<span class="property">_vnode</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ–°æ—§èŠ‚ç‚¹çš„å¯¹æ¯”</span></span><br><span class="line">    <span class="title function_">patch</span>(container.<span class="property">_vnode</span> || <span class="literal">null</span>, vnode, container, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, isSVG);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">flushPostFlushCbs</span>();</span><br><span class="line">  <span class="comment">// è®°å½•æ—§èŠ‚ç‚¹</span></span><br><span class="line">  container.<span class="property">_vnode</span> = vnode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="äºŒã€patch"><a href="#äºŒã€patch" class="headerlink" title="äºŒã€patch"></a>äºŒã€<code>patch</code></h2><h3 id="1-patch"><a href="#1-patch" class="headerlink" title="1. patch"></a>1. <code>patch</code></h3><p><code>patch</code>å‡½æ•°é‡Œä¸»è¦å¯¹æ–°æ—§èŠ‚ç‚¹ä¹Ÿå°±æ˜¯<strong>è™šæ‹Ÿ<code>DOM</code>çš„å¯¹æ¯”</strong>ï¼Œå¸¸è¯´çš„<code>vue</code>é‡Œçš„<code>diff</code>ç®—æ³•ï¼Œä¾¿æ˜¯ä»<code>patch</code>å¼€å§‹ã€‚ç»“åˆ<code>render</code>å‡½æ•°æ¥çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæ—§çš„è™šæ‹Ÿ<code>DOM</code>å­˜å‚¨åœ¨<code>container._vnode</code>ä¸Šã€‚é‚£ä¹ˆ<code>diff</code>çš„æ–¹å¼å°±åœ¨<code>patch</code>ä¸­äº†ï¼š</p>
<ul>
<li><p>æ–°æ—§èŠ‚ç‚¹ç›¸åŒï¼Œç›´æ¥è¿”å›ï¼›</p>
</li>
<li><p>æ—§èŠ‚ç‚¹å­˜åœ¨ï¼Œä¸”æ–°æ—§èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œåˆ™æ—§èŠ‚ç‚¹ä¸å¯å¤ç”¨ï¼Œå°†å…¶å¸è½½(<code>unmount</code>)ï¼Œé”šç‚¹<code>anchor</code>ç§»å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›</p>
</li>
<li><p>æ–°èŠ‚ç‚¹æ˜¯å¦é™æ€èŠ‚ç‚¹æ ‡è®°ï¼›</p>
</li>
<li><p>æ ¹æ®æ–°èŠ‚ç‚¹çš„ç±»å‹ï¼Œç›¸åº”åœ°è°ƒç”¨ä¸åŒç±»å‹çš„å¤„ç†æ–¹æ³•ï¼š</p>
<ul>
<li>æ–‡æœ¬ï¼š<code>processText</code>ï¼›</li>
<li>æ³¨é‡Šï¼š<code>processCommentNode</code>ï¼›</li>
<li>é™æ€èŠ‚ç‚¹ï¼š<code>mountStaticNode</code>æˆ–<code>patchStaticNode</code>ï¼›</li>
<li>æ–‡æ¡£ç‰‡æ®µï¼š<code>processFragment</code>ï¼›</li>
<li>å…¶å®ƒã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨ å…¶å®ƒ è¿™ä¸€é¡¹ä¸­ï¼Œåˆæ ¹æ®å½¢çŠ¶æ ‡è®° <code>shapeFlag</code>ç­‰ï¼Œåˆ¤æ–­æ˜¯ å…ƒç´ èŠ‚ç‚¹ã€ç»„ä»¶èŠ‚ç‚¹ï¼Œæˆ–æ˜¯<code>Teleport</code>ã€<code>Suspense</code>ç­‰ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„<code>process</code>å»å¤„ç†ã€‚æœ€åå¤„ç†<code>template</code>ä¸­çš„<code>ref</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: functions inside this closure should use `const xxx = () =&gt; &#123;&#125;`</span></span><br><span class="line"><span class="comment">// style in order to prevent being inlined by minifiers.</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">patch</span>: <span class="title class_">PatchFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  n1,</span></span></span><br><span class="line"><span class="params"><span class="function">  n2,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  slotScopeIds = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized = __DEV__ &amp;&amp; isHmrUpdating ? <span class="literal">false</span> : !!n2.dynamicChildren</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ–°æ—§èŠ‚ç‚¹ç›¸åŒï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (n1 === n2) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—§èŠ‚ç‚¹å­˜åœ¨ï¼Œä¸”æ–°æ—§èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œå¸è½½æ—§èŠ‚ç‚¹ï¼Œé”šç‚¹anchoråç§»</span></span><br><span class="line">  <span class="comment">// patching &amp; not same type, unmount old tree</span></span><br><span class="line">  <span class="keyword">if</span> (n1 &amp;&amp; !<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">    anchor = <span class="title function_">getNextHostNode</span>(n1);</span><br><span class="line">    <span class="title function_">unmount</span>(n1, parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">    n1 = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦é™æ€èŠ‚ç‚¹ä¼˜åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (n2.<span class="property">patchFlag</span> === <span class="title class_">PatchFlags</span>.<span class="property">BAIL</span>) &#123;</span><br><span class="line">    optimized = <span class="literal">false</span>;</span><br><span class="line">    n2.<span class="property">dynamicChildren</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, ref, shapeFlag &#125; = n2;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Text</span>:</span><br><span class="line">      <span class="title function_">processText</span>(n1, n2, container, anchor);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Comment</span>:</span><br><span class="line">      <span class="title function_">processCommentNode</span>(n1, n2, container, anchor);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Static</span>:</span><br><span class="line">      <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">mountStaticNode</span>(n2, container, anchor, isSVG);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">patchStaticNode</span>(n1, n2, container, isSVG);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Fragment</span>:</span><br><span class="line">      <span class="title function_">processFragment</span>(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processElement</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processComponent</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>) &#123;</span><br><span class="line">        (<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">TeleportImpl</span>).<span class="title function_">process</span>(</span><br><span class="line">          n1 <span class="keyword">as</span> <span class="title class_">TeleportVNode</span>,</span><br><span class="line">          n2 <span class="keyword">as</span> <span class="title class_">TeleportVNode</span>,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized,</span><br><span class="line">          internals</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>) &#123;</span><br><span class="line">        (<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">SuspenseImpl</span>).<span class="title function_">process</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized,</span><br><span class="line">          internals</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">&quot;Invalid VNode type:&quot;</span>, <span class="keyword">type</span>, <span class="string">`(<span class="subst">$&#123;<span class="keyword">typeof</span> <span class="keyword">type</span>&#125;</span>)`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç† template ä¸­çš„ ref</span></span><br><span class="line">  <span class="comment">// set ref</span></span><br><span class="line">  <span class="keyword">if</span> (ref != <span class="literal">null</span> &amp;&amp; parentComponent) &#123;</span><br><span class="line">    <span class="title function_">setRef</span>(ref, n1 &amp;&amp; n1.<span class="property">ref</span>, parentSuspense, n2 || n1, !n2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="2-processText"><a href="#2-processText" class="headerlink" title="2. processText"></a>2. <code>processText</code></h3><p>æ–‡æœ¬èŠ‚ç‚¹çš„å¤„ç†ååˆ†ç®€å•ï¼Œæ²¡æœ‰æ—§èŠ‚ç‚¹åˆ™æ–°å»ºå¹¶æ’å…¥æ–°èŠ‚ç‚¹ï¼›æœ‰æ—§èŠ‚ç‚¹ï¼Œä¸”èŠ‚ç‚¹å†…å®¹ä¸ä¸€è‡´ï¼Œåˆ™è®¾ç½®ä¸ºæ–°èŠ‚ç‚¹çš„å†…å®¹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">processText</span>: <span class="title class_">ProcessTextOrCommentFn</span> = <span class="function">(<span class="params">n1, n2, container, anchor</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">hostInsert</span>(</span><br><span class="line">      (n2.<span class="property">el</span> = <span class="title function_">hostCreateText</span>(n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>)),</span><br><span class="line">      container,</span><br><span class="line">      anchor</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> el = (n2.<span class="property">el</span> = n1.<span class="property">el</span>!);</span><br><span class="line">    <span class="keyword">if</span> (n2.<span class="property">children</span> !== n1.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="title function_">hostSetText</span>(el, n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="3-processCommontNode"><a href="#3-processCommontNode" class="headerlink" title="3. processCommontNode"></a>3. <code>processCommontNode</code></h3><p>ä¸æ”¯æŒåŠ¨æ€çš„æ³¨è§†èŠ‚ç‚¹ï¼Œå› æ­¤åªè¦æ—§èŠ‚ç‚¹å­˜åœ¨ï¼Œå°±ä½¿ç”¨æ—§èŠ‚ç‚¹çš„å†…å®¹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">processCommentNode</span>: <span class="title class_">ProcessTextOrCommentFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  n1,</span></span></span><br><span class="line"><span class="params"><span class="function">  n2,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">hostInsert</span>(</span><br><span class="line">      (n2.<span class="property">el</span> = <span class="title function_">hostCreateComment</span>((n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>) || <span class="string">&quot;&quot;</span>)),</span><br><span class="line">      container,</span><br><span class="line">      anchor</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// there&#x27;s no support for dynamic comments</span></span><br><span class="line">    n2.<span class="property">el</span> = n1.<span class="property">el</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="4-mountStaticNode-å’Œ-patchStaticNode"><a href="#4-mountStaticNode-å’Œ-patchStaticNode" class="headerlink" title="4. mountStaticNode å’Œ patchStaticNode"></a>4. <code>mountStaticNode</code> å’Œ <code>patchStaticNode</code></h3><p>äº‹å®ä¸Šé™æ€èŠ‚ç‚¹æ²¡å•¥å¥½æ¯”è¾ƒçš„ï¼Œæ¯•ç«Ÿæ˜¯é™æ€çš„ã€‚å½“æ²¡æœ‰æ—§èŠ‚ç‚¹æ—¶ï¼Œåˆ™é€šè¿‡<code>mountStaticNode</code>åˆ›å»ºå¹¶æ’å…¥æ–°èŠ‚ç‚¹ï¼›å³ä½¿æœ‰æ—§èŠ‚ç‚¹ï¼Œä¹Ÿä»…åœ¨<code>_DEV_</code>æ¡ä»¶ä¸‹åœ¨<code>hmr</code>ï¼Œæ‰ä¼šä½¿ç”¨<code>patchStaticVnode</code>åšä¸€ä¸‹æ¯”è¾ƒå¹¶é€šè¿‡<code>removeStaticNode</code>ç§»é™¤æŸäº›æ—§èŠ‚ç‚¹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mountStaticNode</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// static nodes are only present when used with compiler-dom/runtime-dom</span></span><br><span class="line">  <span class="comment">// which guarantees presence of hostInsertStaticContent.</span></span><br><span class="line">  [n2.<span class="property">el</span>, n2.<span class="property">anchor</span>] = hostInsertStaticContent!(</span><br><span class="line">    n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">    container,</span><br><span class="line">    anchor,</span><br><span class="line">    isSVG,</span><br><span class="line">    n2.<span class="property">el</span>,</span><br><span class="line">    n2.<span class="property">anchor</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dev / HMR only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">patchStaticNode</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n1: VNode,</span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// static nodes are only patched during dev for HMR</span></span><br><span class="line">  <span class="keyword">if</span> (n2.<span class="property">children</span> !== n1.<span class="property">children</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> anchor = <span class="title function_">hostNextSibling</span>(n1.<span class="property">anchor</span>!);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤å·²æœ‰çš„é™æ€èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// remove existing</span></span><br><span class="line">    <span class="title function_">removeStaticNode</span>(n1);</span><br><span class="line">    <span class="comment">// insert new</span></span><br><span class="line">    [n2.<span class="property">el</span>, n2.<span class="property">anchor</span>] = hostInsertStaticContent!(</span><br><span class="line">      n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      isSVG</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    n2.<span class="property">el</span> = n1.<span class="property">el</span>;</span><br><span class="line">    n2.<span class="property">anchor</span> = n1.<span class="property">anchor</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// removeStaticNodeï¼šä» n1.el è‡³ n1.anchor çš„å†…å®¹è¢«éå†ç§»é™¤</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">removeStaticNode</span> = (<span class="params">&#123; el, anchor &#125;: VNode</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">while</span> (el &amp;&amp; el !== anchor) &#123;</span><br><span class="line">    next = <span class="title function_">hostNextSibling</span>(el);</span><br><span class="line">    <span class="title function_">hostRemove</span>(el);</span><br><span class="line">    el = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">hostRemove</span>(anchor!);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="5-processFragment"><a href="#5-processFragment" class="headerlink" title="5. processFragment"></a>5. <code>processFragment</code></h3><h4 id="5-1-processFragment"><a href="#5-1-processFragment" class="headerlink" title="5.1 processFragment"></a>5.1 <code>processFragment</code></h4><p><code>vue3</code>çš„å•æ–‡ä»¶ç»„ä»¶é‡Œï¼Œä¸å†éœ€è¦åŠ ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå› ä¸ºä½¿ç”¨äº†æ–‡æ¡£ç‰‡æ®µ<code>fragment</code>æ¥æ‰¿è½½å­èŠ‚ç‚¹ï¼Œæœ€åå†ä¸€å¹¶æ·»åŠ åˆ°æ–‡æ¡£ä¸­ã€‚</p>
<ul>
<li><p>è‹¥æ—§çš„ç‰‡æ®µèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™æ’å…¥èµ·å§‹é”šç‚¹ï¼ŒæŒ‚è½½æ–°çš„å­èŠ‚ç‚¹ï¼›</p>
</li>
<li><p>æ—§çš„ç‰‡æ®µä¸ä¸ºç©ºï¼š</p>
<ul>
<li>å­˜åœ¨ä¼˜åŒ–æ¡ä»¶æ—¶ï¼šä½¿ç”¨<code>patchBlockChildren</code>ä¼˜åŒ–<code>diff</code>ï¼›</li>
<li>ä¸å­˜åœ¨ä¼˜åŒ–æ¡ä»¶æ—¶ï¼šä½¿ç”¨<code>patchChildren</code>è¿›è¡Œå…¨é‡<code>diff</code>ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">processFragment</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n1: VNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// é”šç‚¹</span></span><br><span class="line">  <span class="keyword">const</span> fragmentStartAnchor = (n2.<span class="property">el</span> = n1 ? n1.<span class="property">el</span> : <span class="title function_">hostCreateText</span>(<span class="string">&quot;&quot;</span>))!;</span><br><span class="line">  <span class="keyword">const</span> fragmentEndAnchor = (n2.<span class="property">anchor</span> = n1 ? n1.<span class="property">anchor</span> : <span class="title function_">hostCreateText</span>(<span class="string">&quot;&quot;</span>))!;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> &#123; patchFlag, dynamicChildren, <span class="attr">slotScopeIds</span>: fragmentSlotScopeIds &#125; = n2;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å‘ç¯å¢ƒçƒ­æ›´æ–°æ—¶ï¼Œå¼ºåˆ¶å…¨é‡diff</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">    <span class="comment">// #5523 dev root fragment may inherit directives</span></span><br><span class="line">    (isHmrUpdating || patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">DEV_ROOT_FRAGMENT</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// HMR updated / Dev root fragment (w/ comments), force full diff</span></span><br><span class="line">    patchFlag = <span class="number">0</span>;</span><br><span class="line">    optimized = <span class="literal">false</span>;</span><br><span class="line">    dynamicChildren = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦æ˜¯æ’æ§½</span></span><br><span class="line">  <span class="comment">// check if this is a slot fragment with :slotted scope ids</span></span><br><span class="line">  <span class="keyword">if</span> (fragmentSlotScopeIds) &#123;</span><br><span class="line">    slotScopeIds = slotScopeIds</span><br><span class="line">      ? slotScopeIds.<span class="title function_">concat</span>(fragmentSlotScopeIds)</span><br><span class="line">      : fragmentSlotScopeIds;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“æ—§çš„ç‰‡æ®µä¸ºç©ºæ—¶ï¼ŒæŒ‚è½½æ–°çš„ç‰‡æ®µçš„å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">hostInsert</span>(fragmentStartAnchor, container, anchor);</span><br><span class="line">    <span class="title function_">hostInsert</span>(fragmentEndAnchor, container, anchor);</span><br><span class="line">    <span class="comment">// a fragment can only have array children</span></span><br><span class="line">    <span class="comment">// since they are either generated by the compiler, or implicitly created</span></span><br><span class="line">    <span class="comment">// from arrays.</span></span><br><span class="line">    <span class="title function_">mountChildren</span>(</span><br><span class="line">      n2.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">      container,</span><br><span class="line">      fragmentEndAnchor,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å½“æ—§ç‰‡æ®µä¸ä¸ºç©ºæ—¶ï¼Œå¯ç”¨ä¼˜åŒ–åˆ™ä½¿ç”¨patchBlockChildren</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      patchFlag &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">STABLE_FRAGMENT</span> &amp;&amp;</span><br><span class="line">      dynamicChildren &amp;&amp;</span><br><span class="line">      <span class="comment">// #2715 the previous fragment could&#x27;ve been a BAILed one as a result</span></span><br><span class="line">      <span class="comment">// of renderSlot() with no valid children</span></span><br><span class="line">      n1.<span class="property">dynamicChildren</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// a stable fragment (template root or &lt;template v-for&gt;) doesn&#x27;t need to</span></span><br><span class="line">      <span class="comment">// patch children order, but it may contain dynamicChildren.</span></span><br><span class="line">      <span class="title function_">patchBlockChildren</span>(</span><br><span class="line">        n1.<span class="property">dynamicChildren</span>,</span><br><span class="line">        dynamicChildren,</span><br><span class="line">        container,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// å¼€å‘ç¯å¢ƒï¼Œçƒ­æ›´æ–° å¤„ç†é™æ€å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; parentComponent &amp;&amp; parentComponent.<span class="property">type</span>.<span class="property">__hmrId</span>) &#123;</span><br><span class="line">        <span class="title function_">traverseStaticChildren</span>(n1, n2);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// #2080 if the stable fragment has a key, it&#x27;s a &lt;template v-for&gt; that may</span></span><br><span class="line">        <span class="comment">//  get moved around. Make sure all root level vnodes inherit el.</span></span><br><span class="line">        <span class="comment">// #2134 or if it&#x27;s a component root, it may also get moved around</span></span><br><span class="line">        <span class="comment">// as the component is being moved.</span></span><br><span class="line">        n2.<span class="property">key</span> != <span class="literal">null</span> ||</span><br><span class="line">        (parentComponent &amp;&amp; n2 === parentComponent.<span class="property">subTree</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">traverseStaticChildren</span>(n1, n2, <span class="literal">true</span> <span class="comment">/* shallow */</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸å¯ä¼˜åŒ–æ—¶ï¼Œä½¿ç”¨patchChildrenå¤„ç†</span></span><br><span class="line">      <span class="comment">// keyed / unkeyed, or manual fragments.</span></span><br><span class="line">      <span class="comment">// for keyed &amp; unkeyed, since they are compiler generated from v-for,</span></span><br><span class="line">      <span class="comment">// each child is guaranteed to be a block so the fragment will never</span></span><br><span class="line">      <span class="comment">// have dynamicChildren.</span></span><br><span class="line">      <span class="title function_">patchChildren</span>(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        fragmentEndAnchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-patchBlockChildren"><a href="#5-2-patchBlockChildren" class="headerlink" title="5.2 patchBlockChildren"></a>5.2 <code>patchBlockChildren</code></h4><p>åœ¨æ–‡æ¡£ç‰‡æ®µä¸­çš„<code>diff</code>ä¸­ï¼Œå½“ç¬¦åˆä¼˜åŒ–æ¡ä»¶æ—¶ï¼Œåˆ™è°ƒç”¨<code>patchBlockChildren</code>æ¥è¿›è¡Œä¼˜åŒ–çš„<code>diff</code>ã€‚è¿™é‡Œä¸»è¦ä»¥æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹é•¿åº¦ä¸ºå‡†ï¼Œéå†æ–°æ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œæ›´æ–°äº†æ¯ä¸ªå­èŠ‚ç‚¹çš„<code>container</code>ç„¶åè¿›è¡Œ<code>patch</code>ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The fast path for blocks.</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">patchBlockChildren</span>: <span class="title class_">PatchBlockChildrenFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  oldChildren,</span></span></span><br><span class="line"><span class="params"><span class="function">  newChildren,</span></span></span><br><span class="line"><span class="params"><span class="function">  fallbackContainer,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  slotScopeIds</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVNode = oldChildren[i];</span><br><span class="line">    <span class="keyword">const</span> newVNode = newChildren[i];</span><br><span class="line">    <span class="comment">// Determine the container (parent element) for the patch.</span></span><br><span class="line">    <span class="keyword">const</span> container =</span><br><span class="line">      <span class="comment">// oldVNode may be an errored async setup() component inside Suspense</span></span><br><span class="line">      <span class="comment">// which will not have a mounted element</span></span><br><span class="line">      oldVNode.<span class="property">el</span> &amp;&amp;</span><br><span class="line">      <span class="comment">// - In the case of a Fragment, we need to provide the actual parent</span></span><br><span class="line">      <span class="comment">// of the Fragment itself so it can move its children.</span></span><br><span class="line">      (oldVNode.<span class="property">type</span> === <span class="title class_">Fragment</span> ||</span><br><span class="line">        <span class="comment">// - In the case of different nodes, there is going to be a replacement</span></span><br><span class="line">        <span class="comment">// which also requires the correct parent container</span></span><br><span class="line">        !<span class="title function_">isSameVNodeType</span>(oldVNode, newVNode) ||</span><br><span class="line">        <span class="comment">// - In the case of a component, it could contain anything.</span></span><br><span class="line">        oldVNode.<span class="property">shapeFlag</span> &amp; (<span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT</span> | <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>))</span><br><span class="line">        ? <span class="title function_">hostParentNode</span>(oldVNode.<span class="property">el</span>)!</span><br><span class="line">        : <span class="comment">// In other cases, the parent container is not actually used so we</span></span><br><span class="line">          <span class="comment">// just pass the block element here to avoid a DOM parentNode call.</span></span><br><span class="line">          fallbackContainer;</span><br><span class="line">    <span class="title function_">patch</span>(</span><br><span class="line">      oldVNode,</span><br><span class="line">      newVNode,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-patchChildren"><a href="#5-3-patchChildren" class="headerlink" title="5.3 patchChildren"></a>5.3 <code>patchChildren</code></h4><p>åœ¨æ²¡æœ‰ä¼˜åŒ–æ¡ä»¶æ—¶ï¼Œä½¿ç”¨<code>patchChildren</code>å¯¹å­èŠ‚ç‚¹è¿›è¡Œå…¨é‡çš„<code>diff</code>ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">patchChildren</span>: <span class="title class_">PatchChildrenFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  n1,</span></span></span><br><span class="line"><span class="params"><span class="function">  n2,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  slotScopeIds,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> c1 = n1 &amp;&amp; n1.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">const</span> prevShapeFlag = n1 ? n1.<span class="property">shapeFlag</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> c2 = n2.<span class="property">children</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; patchFlag, shapeFlag &#125; = n2;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ°ç»¿è‰²é€šé“ï¼šç”¨patchFlagæ¥ä¿è¯childrenæ˜¯æ•°ç»„</span></span><br><span class="line">  <span class="comment">// fast path</span></span><br><span class="line">  <span class="keyword">if</span> (patchFlag &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">KEYED_FRAGMENT</span>) &#123;</span><br><span class="line">      <span class="comment">// æœ‰keyå±æ€§çš„æ—¶å€™ï¼Œæ ¹æ®keyæ¥è¿›è¡Œdiff</span></span><br><span class="line">      <span class="comment">// this could be either fully-keyed or mixed (some keyed some not)</span></span><br><span class="line">      <span class="comment">// presence of patchFlag means children are guaranteed to be arrays</span></span><br><span class="line">      <span class="title function_">patchKeyedChildren</span>(</span><br><span class="line">        c1 <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">        c2 <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">UNKEYED_FRAGMENT</span>) &#123;</span><br><span class="line">      <span class="comment">// æ²¡æœ‰key</span></span><br><span class="line">      <span class="comment">// unkeyed</span></span><br><span class="line">      <span class="title function_">patchUnkeyedChildren</span>(</span><br><span class="line">        c1 <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">        c2 <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ²¡æœ‰patchFlagçš„ä¿è¯ï¼Œåˆ™childrenå¯èƒ½ä¸ºæ–‡æœ¬ã€æ•°ç»„æˆ–ç©º</span></span><br><span class="line">  <span class="comment">// æ ¹æ®å½¢çŠ¶æ ‡è¯†æ¥åˆ¤æ–­</span></span><br><span class="line">  <span class="comment">// children has 3 possibilities: text, array or no children.</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="comment">// æ–‡æœ¬å­èŠ‚ç‚¹çš„ç»¿è‰²é€šé“</span></span><br><span class="line">    <span class="comment">// text children fast path</span></span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="title function_">unmountChildren</span>(c1 <span class="keyword">as</span> <span class="title class_">VNode</span>[], parentComponent, parentSuspense);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c2 !== c1) &#123;</span><br><span class="line">      <span class="title function_">hostSetElementText</span>(container, c2 <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ—§çš„å­èŠ‚ç‚¹æ˜¯æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// prev children was array</span></span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">        <span class="comment">// æ–°æ—§å­èŠ‚ç‚¹éƒ½æ˜¯æ•°ç»„ï¼Œéœ€è¦è¿›è¡Œå…¨é‡diff</span></span><br><span class="line">        <span class="comment">// two arrays, cannot assume anything, do full diff</span></span><br><span class="line">        <span class="title function_">patchKeyedChildren</span>(</span><br><span class="line">          c1 <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">          c2 <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ–°çš„å­èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™åªéœ€è¦å¸è½½æ—§çš„å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// no new children, just unmount old</span></span><br><span class="line">        <span class="title function_">unmountChildren</span>(c1 <span class="keyword">as</span> <span class="title class_">VNode</span>[], parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æ—§çš„å­èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹æˆ–è€…ç©ºï¼Œæ–°çš„ä¸ºæ•°ç»„æˆ–ç©º</span></span><br><span class="line">      <span class="comment">// prev children was text OR null</span></span><br><span class="line">      <span class="comment">// new children is array OR null</span></span><br><span class="line">      <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">        <span class="comment">// æ—§çš„ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œå…ˆå°†å…¶æ–‡æœ¬ç½®ç©º</span></span><br><span class="line">        <span class="title function_">hostSetElementText</span>(container, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ–°çš„ä¸ºæ•°ç»„ï¼Œåˆ™é€šè¿‡mountChildrenæŒ‚è½½å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="comment">// mount new if array</span></span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">        <span class="title function_">mountChildren</span>(</span><br><span class="line">          c2 <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-4-patchKeyedChildren"><a href="#5-4-patchKeyedChildren" class="headerlink" title="5.4 patchKeyedChildren"></a>5.4 <code>patchKeyedChildren</code></h4><p>ä½¿ç”¨<code>patchKeyedChildren</code>æ¥æ¯”è¾ƒä¸¤ç»„æœ‰<code>key</code>ï¼Œæˆ–è€…æœ‰<code>key</code>å’Œæ²¡æœ‰<code>key</code>æ··åˆçš„<code>children</code>ï¼Œå±äº<code>diff</code>çš„æ ¸å¿ƒå†…å®¹äº†ã€‚</p>
<ul>
<li><p>ä»å‰å¾€åä¾æ¬¡å¯¹æ¯”ç›¸åŒç´¢å¼•ä½ç½®çš„èŠ‚ç‚¹ç±»å‹ï¼Œå½“é‡åˆ°èŠ‚ç‚¹ç±»å‹ä¸åŒåˆ™é€€å‡ºæ¯”è¾ƒï¼›</p>
</li>
<li><p>å†ä»åå¾€å‰å¯¹æ¯”ç›¸åŒå€’åºä½ç½®ä¸Šçš„èŠ‚ç‚¹ç±»å‹ï¼Œé‡åˆ°ä¸åŒç±»å‹åˆ™é€€å‡ºæ¯”è¾ƒï¼›</p>
</li>
<li><p>å¦‚æœæ—§èŠ‚ç‚¹ç»„éå†å®Œï¼Œè€Œæ–°èŠ‚ç‚¹ç»„è¿˜æœ‰å†…å®¹ï¼Œåˆ™æŒ‚è½½æ–°èŠ‚ç‚¹ç»„é‡Œçš„å‰©ä½™å†…å®¹ï¼›</p>
</li>
<li><p>å¦‚æœæ–°èŠ‚ç‚¹ç»„éå†å®Œï¼Œè€Œæ—§èŠ‚ç‚¹ç»„è¿˜æœ‰å†…å®¹ï¼Œåˆ™å¸è½½æ—§èŠ‚ç‚¹ç»„é‡Œçš„å‰©ä½™å†…å®¹ï¼›</p>
</li>
<li><p>å¦‚æœéƒ½æ²¡æœ‰éå†å®Œï¼š</p>
<ul>
<li>å°†æ–°èŠ‚ç‚¹ç»„çš„å‰©ä½™å†…å®¹ä»¥<code>key=&gt;index</code>çš„å½¢å¼å­˜å…¥<code>Map</code>ï¼›</li>
<li>éå†å‰©ä½™çš„æ—§å­èŠ‚ç‚¹ï¼Œåœ¨<code>Map</code>ä¸­æ‰¾åˆ°ç›¸åŒçš„<code>key</code>å¯¹åº”çš„<code>index</code>ï¼›</li>
<li>å¦‚æœæ—§å­èŠ‚ç‚¹æ²¡æœ‰<code>key</code>ï¼Œåˆ™æ‰¾åˆ°æ–°å­èŠ‚ç‚¹ç»„çš„å‰©ä½™å­èŠ‚ç‚¹ä¸­å°šæœªè¢«åŒ¹é…åˆ°ä¸”ç±»å‹ç›¸åŒçš„èŠ‚ç‚¹å¯¹åº”çš„<code>index</code>ï¼›</li>
<li>æ±‚å‡ºæœ€å¤§é€’å¢å­åºåˆ—ï¼›</li>
<li>å¸è½½ä¸åŒ¹é…çš„æ—§å­èŠ‚ç‚¹ã€æŒ‚è½½æœªè¢«åŒ¹é…çš„æ–°å­èŠ‚ç‚¹ï¼Œç§»åŠ¨éœ€è¦ç§»åŠ¨çš„å¯å¤ç”¨å­èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// can be all-keyed or mixed</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">patchKeyedChildren</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  c1: VNode[],</span></span><br><span class="line"><span class="params">  c2: VNodeArrayChildren,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  parentAnchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> l2 = c2.<span class="property">length</span>;</span><br><span class="line">  <span class="comment">// ä¸¤ç»„å„è‡ªçš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span>; <span class="comment">// prev ending index</span></span><br><span class="line">  <span class="keyword">let</span> e2 = l2 - <span class="number">1</span>; <span class="comment">// next ending index</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// (ä»å‰å¾€å)</span></span><br><span class="line">  <span class="comment">// ä»¥ä¸¤ç»„ä¸­æœ€çŸ­çš„ä¸€ç»„ä¸ºåŸºå‡†</span></span><br><span class="line">  <span class="comment">// ä»å¤´ç»“ç‚¹å¼€å§‹ï¼Œä¾æ¬¡æ¯”è¾ƒåŒä¸€ä½ç½®çš„èŠ‚ç‚¹ç±»å‹ï¼Œè‹¥å¤´èŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œåˆ™å¯¹ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œpatchè¿›è¡Œæ¯”è¾ƒ;</span></span><br><span class="line">  <span class="comment">// è‹¥ç±»å‹ä¸åŒåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">  <span class="comment">// 1. sync from start</span></span><br><span class="line">  <span class="comment">// (a b) c</span></span><br><span class="line">  <span class="comment">// (a b) d e</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = (c2[i] = optimized</span><br><span class="line">      ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">      : <span class="title function_">normalizeVNode</span>(c2[i]));</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (ä»åå¾€å‰)</span></span><br><span class="line">  <span class="comment">// ä»å°¾èŠ‚ç‚¹å¼€å§‹ï¼Œå°¾èŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œåˆ™é€šè¿‡patchæ¯”è¾ƒå°¾èŠ‚ç‚¹ï¼›</span></span><br><span class="line">  <span class="comment">// è‹¥ç±»å‹ä¸åŒåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">  <span class="comment">// 2. sync from end</span></span><br><span class="line">  <span class="comment">// a (b c)</span></span><br><span class="line">  <span class="comment">// d e (b c)</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[e1];</span><br><span class="line">    <span class="keyword">const</span> n2 = (c2[e2] = optimized</span><br><span class="line">      ? <span class="title function_">cloneIfMounted</span>(c2[e2] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">      : <span class="title function_">normalizeVNode</span>(c2[e2]));</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    e1--;</span><br><span class="line">    e2--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»è¿‡å‰åä¸¤è½®æ¯”è¾ƒä¹‹åï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸­é—´é‚£éƒ¨åˆ†ç±»å‹ä¸åŒçš„å­èŠ‚ç‚¹äº†</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‹¥æ—§çš„å­èŠ‚ç‚¹ç»„å·²ç»éå†å®Œï¼Œè€Œæ–°çš„å­èŠ‚ç‚¹ç»„è¿˜æœ‰å‰©ä½™å†…å®¹</span></span><br><span class="line">  <span class="comment">// é€šè¿‡patchå¤„ç†å‰©ä¸‹çš„æ–°çš„å­èŠ‚ç‚¹ä¸­çš„å†…å®¹ï¼Œç”±äºæ—§çš„å­èŠ‚ç‚¹ä¸ºç©ºï¼Œ</span></span><br><span class="line">  <span class="comment">// å› æ­¤ç›¸å½“äºåœ¨patchå†…éƒ¨æŒ‚è½½å‰©ä½™çš„æ–°çš„å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="comment">// 3. common sequence + mount</span></span><br><span class="line">  <span class="comment">// (a b)</span></span><br><span class="line">  <span class="comment">// (a b) c</span></span><br><span class="line">  <span class="comment">// i = 2, e1 = 1, e2 = 2</span></span><br><span class="line">  <span class="comment">// (a b)</span></span><br><span class="line">  <span class="comment">// c (a b)</span></span><br><span class="line">  <span class="comment">// i = 0, e1 = -1, e2 = 0</span></span><br><span class="line">  <span class="keyword">if</span> (i &gt; e1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt;= e2) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextPos = e2 + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">const</span> anchor = nextPos &lt; l2 ? (c2[nextPos] <span class="keyword">as</span> <span class="title class_">VNode</span>).<span class="property">el</span> : parentAnchor;</span><br><span class="line">      <span class="keyword">while</span> (i &lt;= e2) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          (c2[i] = optimized</span><br><span class="line">            ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">            : <span class="title function_">normalizeVNode</span>(c2[i])),</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—§çš„å­èŠ‚ç‚¹è¿˜æœ‰å‰©ä½™å†…å®¹è€Œæ–°çš„å­èŠ‚ç‚¹ç»„å·²ç»éå†å®Œï¼Œåˆ™å¸è½½æ—§å­èŠ‚ç‚¹ç»„å‰©ä½™çš„é‚£éƒ¨åˆ†</span></span><br><span class="line">  <span class="comment">// 4. common sequence + unmount</span></span><br><span class="line">  <span class="comment">// (a b) c</span></span><br><span class="line">  <span class="comment">// (a b)</span></span><br><span class="line">  <span class="comment">// i = 2, e1 = 2, e2 = 1</span></span><br><span class="line">  <span class="comment">// a (b c)</span></span><br><span class="line">  <span class="comment">// (b c)</span></span><br><span class="line">  <span class="comment">// i = 0, e1 = 0, e2 = -1</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (i &gt; e2) &#123;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1) &#123;</span><br><span class="line">      <span class="title function_">unmount</span>(c1[i], parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–°æ—§å­èŠ‚ç‚¹ç»„éƒ½æ²¡æœ‰éå†å®Œï¼Œå¦‚ä¸‹æ³¨é‡Šä¸­[]é‡Œçš„éƒ¨åˆ†</span></span><br><span class="line">  <span class="comment">// 5. unknown sequence</span></span><br><span class="line">  <span class="comment">// [i ... e1 + 1]: a b [c d e] f g</span></span><br><span class="line">  <span class="comment">// [i ... e2 + 1]: a b [e d c h] f g</span></span><br><span class="line">  <span class="comment">// i = 2, e1 = 4, e2 = 5</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ä¸Šæ¬¡æ¯”è¾ƒå®Œçš„èµ·ç‚¹</span></span><br><span class="line">    <span class="keyword">const</span> s1 = i; <span class="comment">// prev starting index</span></span><br><span class="line">    <span class="keyword">const</span> s2 = i; <span class="comment">// next starting index</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.1 build key:index map for newChildren</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">keyToNewIndexMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="comment">// ç”¨Mapå­˜å‚¨æ–°çš„å­èŠ‚ç‚¹ç»„çš„keyå’Œå¯¹åº”çš„indexï¼Œ key=&gt;index å¹¶ç»™å‡ºé‡å¤çš„keyçš„è­¦å‘Š</span></span><br><span class="line">    <span class="keyword">for</span> (i = s2; i &lt;= e2; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextChild = (c2[i] = optimized</span><br><span class="line">        ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">        : <span class="title function_">normalizeVNode</span>(c2[i]));</span><br><span class="line">      <span class="keyword">if</span> (nextChild.<span class="property">key</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; keyToNewIndexMap.<span class="title function_">has</span>(nextChild.<span class="property">key</span>)) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Duplicate keys found during update:`</span>,</span><br><span class="line">            <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(nextChild.<span class="property">key</span>),</span><br><span class="line">            <span class="string">`Make sure keys are unique.`</span></span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        keyToNewIndexMap.<span class="title function_">set</span>(nextChild.<span class="property">key</span>, i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.2 loop through old children left to be patched and try to patch</span></span><br><span class="line">    <span class="comment">// matching nodes &amp; remove nodes that are no longer present</span></span><br><span class="line">    <span class="keyword">let</span> j;</span><br><span class="line">    <span class="comment">// å·²æ¯”è¾ƒçš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">let</span> patched = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æœªæ¯”è¾ƒçš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> moved = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// used to track whether any node has moved</span></span><br><span class="line">    <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// works as Map&lt;newIndex, oldIndex&gt;</span></span><br><span class="line">    <span class="comment">// Note that oldIndex is offset by +1</span></span><br><span class="line">    <span class="comment">// and oldIndex = 0 is a special value indicating the new node has</span></span><br><span class="line">    <span class="comment">// no corresponding old node.</span></span><br><span class="line">    <span class="comment">// used for determining longest stable subsequence</span></span><br><span class="line">    <span class="comment">// ä»¥æ–°çš„å­èŠ‚ç‚¹ç»„ä¸­æœªå®Œæˆæ¯”è¾ƒçš„èŠ‚ç‚¹ä¸ºåŸºå‡†</span></span><br><span class="line">    <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="title class_">Array</span>(toBePatched);</span><br><span class="line">    <span class="comment">// å…ˆç”¨0æ¥å¡«å……ï¼Œæ ‡è®°ä¸ºæ²¡æœ‰keyçš„èŠ‚ç‚¹ã€‚ ps:ç›´æ¥fill(0)ä¸å°±å¥½äº†ä¹ˆ</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; toBePatched; i++) newIndexToOldIndexMap[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ—§çš„å­èŠ‚ç‚¹ç»„</span></span><br><span class="line">    <span class="keyword">for</span> (i = s1; i &lt;= e1; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> prevChild = c1[i];</span><br><span class="line">      <span class="comment">// å½“å·²ç»æ¯”è¾ƒå®Œäº†(patched &gt;= toBePatched)ï¼Œå¸è½½æ—§çš„å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (patched &gt;= toBePatched) &#123;</span><br><span class="line">        <span class="comment">// all new children have been patched so this can only be a removal</span></span><br><span class="line">        <span class="title function_">unmount</span>(prevChild, parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> newIndex;</span><br><span class="line">      <span class="comment">// å½“æ—§çš„å­èŠ‚ç‚¹çš„keyå­˜åœ¨ï¼Œå–å‡ºkeyåœ¨æ–°çš„å­èŠ‚ç‚¹ç»„ä¸­å¯¹åº”çš„index</span></span><br><span class="line">      <span class="keyword">if</span> (prevChild.<span class="property">key</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        newIndex = keyToNewIndexMap.<span class="title function_">get</span>(prevChild.<span class="property">key</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è‹¥æ—§çš„å­èŠ‚ç‚¹æ²¡æœ‰keyï¼Œæ‰¾å‡ºæ²¡æœ‰keyä¸”ç±»å‹ç›¸åŒçš„èŠ‚ç‚¹å¯¹åº”åœ¨æ–°å­èŠ‚ç‚¹ç»„ä¸­çš„index</span></span><br><span class="line">        <span class="comment">// key-less node, try to locate a key-less node of the same type</span></span><br><span class="line">        <span class="keyword">for</span> (j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            newIndexToOldIndexMap[j - s2] === <span class="number">0</span> &amp;&amp;</span><br><span class="line">            <span class="title function_">isSameVNodeType</span>(prevChild, c2[j] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">          ) &#123;</span><br><span class="line">            newIndex = j;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// newIndexä¸å­˜åœ¨ï¼Œå³æ ¹æ®keyæ¥æ‰¾ï¼Œå‘ç°æ—§çš„å­èŠ‚ç‚¹ä¸å¯å¤ç”¨ï¼Œåˆ™å¸è½½æ—§çš„å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">if</span> (newIndex === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="title function_">unmount</span>(prevChild, parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°äº†å¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œåœ¨newIndexToOldIndexMapä¸­æ ‡è®° i+1ï¼Œ</span></span><br><span class="line">        <span class="comment">// ç”¨äºæœ€å¤§ä¸Šå‡å­åºåˆ—ç®—æ³•</span></span><br><span class="line">        newIndexToOldIndexMap[newIndex - s2] = i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// åˆ·æ–°ç›®å‰æ‰¾åˆ°çš„æœ€å¤§çš„æ–°å­èŠ‚ç‚¹çš„indexï¼ŒåšèŠ‚ç‚¹ç§»åŠ¨æ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (newIndex &gt;= maxNewIndexSoFar) &#123;</span><br><span class="line">          maxNewIndexSoFar = newIndex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          moved = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å†é€’å½’è¯¦ç»†æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          prevChild,</span><br><span class="line">          c2[newIndex] <span class="keyword">as</span> <span class="title class_">VNode</span>,</span><br><span class="line">          container,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// å·²å¯¹æ¯”çš„æ•°é‡+1</span></span><br><span class="line">        patched++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“éœ€è¦ç§»åŠ¨æ—¶ï¼Œé‡‡ç”¨æœ€å¤§é€’å¢å­åºåˆ—ç®—æ³•ï¼Œä»è€Œæœ€å¤§é™åº¦å‡å°‘èŠ‚ç‚¹ç§»åŠ¨æ¬¡æ•°</span></span><br><span class="line">    <span class="comment">// 5.3 move and mount</span></span><br><span class="line">    <span class="comment">// generate longest stable subsequence only when nodes have moved</span></span><br><span class="line">    <span class="keyword">const</span> increasingNewIndexSequence = moved</span><br><span class="line">      ? <span class="title function_">getSequence</span>(newIndexToOldIndexMap)</span><br><span class="line">      : <span class="variable constant_">EMPTY_ARR</span>;</span><br><span class="line">    j = increasingNewIndexSequence.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å€’åºéå†ï¼Œå¥½å¤„æ˜¯å¯ä»¥ä½¿ç”¨ä¸Šä¸€æ¬¡å¯¹æ¯”çš„èŠ‚ç‚¹ä½œä¸ºé”šç‚¹</span></span><br><span class="line">    <span class="comment">// looping backwards so that we can use last patched node as anchor</span></span><br><span class="line">    <span class="keyword">for</span> (i = toBePatched - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextIndex = s2 + i;</span><br><span class="line">      <span class="keyword">const</span> nextChild = c2[nextIndex] <span class="keyword">as</span> <span class="title class_">VNode</span>;</span><br><span class="line">      <span class="keyword">const</span> anchor =</span><br><span class="line">        nextIndex + <span class="number">1</span> &lt; l2 ? (c2[nextIndex + <span class="number">1</span>] <span class="keyword">as</span> <span class="title class_">VNode</span>).<span class="property">el</span> : parentAnchor;</span><br><span class="line">      <span class="keyword">if</span> (newIndexToOldIndexMap[i] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç­‰äº0è¯´æ˜æœªè¢«æ—§çš„å­èŠ‚ç‚¹åŒ¹é…åˆ°ï¼Œå±äºå…¨æ–°çš„ä¸å¯å¤ç”¨çš„å­èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡patchè¿›è¡ŒæŒ‚è½½</span></span><br><span class="line">        <span class="comment">// mount new</span></span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          nextChild,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (moved) &#123;</span><br><span class="line">        <span class="comment">// å½“è®¡ç®—å‡ºæ¥çš„æœ€å¤§ä¸Šå‡å­åºåˆ—ä¸ºç©ºæ•°ç»„ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ–è€…å½“å‰èŠ‚ç‚¹ä¸å¤„äºæœ€å¤§ä¸Šå‡å­åºåˆ—ä¸­</span></span><br><span class="line">        <span class="comment">// move if:</span></span><br><span class="line">        <span class="comment">// There is no stable subsequence (e.g. a reverse)</span></span><br><span class="line">        <span class="comment">// OR current node is not among the stable sequence</span></span><br><span class="line">        <span class="keyword">if</span> (j &lt; <span class="number">0</span> || i !== increasingNewIndexSequence[j]) &#123;</span><br><span class="line">          <span class="title function_">move</span>(nextChild, container, anchor, <span class="title class_">MoveType</span>.<span class="property">REORDER</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          j--;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-5-patchUnkeyedChildren"><a href="#5-5-patchUnkeyedChildren" class="headerlink" title="5.5 patchUnkeyedChildren"></a>5.5 <code>patchUnkeyedChildren</code></h4><p>æ²¡æœ‰<code>key</code>çš„æ—¶å€™å°±å¾ˆç›´æ¥äº†ï¼Œåªä¾ç…§æœ€çŸ­çš„é‚£ç»„çš„é•¿åº¦ï¼Œæ¥æŒ‰ä½ç½®è¿›è¡Œæ¯”è¾ƒã€‚è€Œåè¯¥å¸è½½å°±å¸è½½ï¼Œè¯¥æŒ‚è½½å°±æŒ‚è½½ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patchUnkeyedChildren</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  c1: VNode[],</span></span><br><span class="line"><span class="params">  c2: VNodeArrayChildren,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  c1 = c1 || <span class="variable constant_">EMPTY_ARR</span>;</span><br><span class="line">  c2 = c2 || <span class="variable constant_">EMPTY_ARR</span>;</span><br><span class="line">  <span class="keyword">const</span> oldLength = c1.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">const</span> newLength = c2.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">const</span> commonLength = <span class="title class_">Math</span>.<span class="title function_">min</span>(oldLength, newLength);</span><br><span class="line">  <span class="keyword">let</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; commonLength; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> nextChild = (c2[i] = optimized</span><br><span class="line">      ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">      : <span class="title function_">normalizeVNode</span>(c2[i]));</span><br><span class="line">    <span class="title function_">patch</span>(</span><br><span class="line">      c1[i],</span><br><span class="line">      nextChild,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (oldLength &gt; newLength) &#123;</span><br><span class="line">    <span class="comment">// remove old</span></span><br><span class="line">    <span class="title function_">unmountChildren</span>(</span><br><span class="line">      c1,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      commonLength</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// mount new</span></span><br><span class="line">    <span class="title function_">mountChildren</span>(</span><br><span class="line">      c2,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized,</span><br><span class="line">      commonLength</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-6-mountChildren"><a href="#5-6-mountChildren" class="headerlink" title="5.6 mountChildren"></a>5.6 <code>mountChildren</code></h4><p><code>mountChildren</code>ç”¨äºæŒ‚è½½å­èŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯éå†å­èŠ‚ç‚¹ï¼Œå¤„ç†æ¯ä¸ªå­èŠ‚ç‚¹ï¼Œå¾—åˆ°å¤åˆ¶çš„æˆ–è€…æ ‡å‡†åŒ–çš„å•ä¸ªå­èŠ‚ç‚¹ï¼Œç„¶åé€’å½’è°ƒç”¨<code>patch</code>ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">mountChildren</span>: <span class="title class_">MountChildrenFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  children,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  slotScopeIds,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized,</span></span></span><br><span class="line"><span class="params"><span class="function">  start = <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> child = (children[i] = optimized</span><br><span class="line">      ? <span class="title function_">cloneIfMounted</span>(children[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">      : <span class="title function_">normalizeVNode</span>(children[i]));</span><br><span class="line">    <span class="title function_">patch</span>(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      child,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-7-unmountChildren"><a href="#5-7-unmountChildren" class="headerlink" title="5.7 unmountChildren"></a>5.7 <code>unmountChildren</code></h4><p>éå†å­èŠ‚ç‚¹ç»„ï¼Œè°ƒç”¨<code>unmount</code>æ–¹æ³•å¸è½½å­èŠ‚ç‚¹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">unmountChildren</span>: <span class="title class_">UnmountChildrenFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  children,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  doRemove = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  start = <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">unmount</span>(children[i], parentComponent, parentSuspense, doRemove, optimized);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-8-move"><a href="#5-8-move" class="headerlink" title="5.8 move"></a>5.8 <code>move</code></h4><p>åœ¨æœ‰<code>key</code>çš„å­èŠ‚ç‚¹æ¯”è¾ƒä¸­ï¼Œå‡ºç°äº†éœ€è¦ç§»åŠ¨å­èŠ‚ç‚¹çš„æƒ…å†µï¼Œè€Œç§»åŠ¨å°±æ˜¯é€šè¿‡<code>move</code>æ¥å®Œæˆçš„ã€‚æŒ‰ç…§ä¸åŒçš„èŠ‚ç‚¹ç±»å‹ï¼Œå¤„ç†æ–¹å¼æœ‰æ‰€å·®å¼‚ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">move</span>: <span class="title class_">MoveFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  vnode,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  moveType,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; el, <span class="keyword">type</span>, transition, children, shapeFlag &#125; = vnode;</span><br><span class="line">  <span class="comment">// å¯¹äºç»„ä»¶èŠ‚ç‚¹ï¼Œé€’å½’å¤„ç†subTree</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT</span>) &#123;</span><br><span class="line">    <span class="title function_">move</span>(vnode.<span class="property">component</span>!.<span class="property">subTree</span>, container, anchor, moveType);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å¼‚æ­¥ç»„ä»¶&lt;Suspense&gt;</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>) &#123;</span><br><span class="line">    vnode.<span class="property">suspense</span>!.<span class="title function_">move</span>(container, anchor, moveType);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†&lt;Teleport&gt;</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>) &#123;</span><br><span class="line">    (<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">TeleportImpl</span>).<span class="title function_">move</span>(vnode, container, anchor, internals);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡æ¡£ç‰‡æ®µï¼Œå¤„ç†èµ·å§‹é”šç‚¹å’Œå­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">Fragment</span>) &#123;</span><br><span class="line">    <span class="title function_">hostInsert</span>(el!, container, anchor);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; (children <span class="keyword">as</span> <span class="title class_">VNode</span>[]).<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="title function_">move</span>((children <span class="keyword">as</span> <span class="title class_">VNode</span>[])[i], container, anchor, moveType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">hostInsert</span>(vnode.<span class="property">anchor</span>!, container, anchor);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é™æ€èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">Static</span>) &#123;</span><br><span class="line">    <span class="title function_">moveStaticNode</span>(vnode, container, anchor);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†&lt;Transition&gt;çš„é’©å­</span></span><br><span class="line">  <span class="comment">// single nodes</span></span><br><span class="line">  <span class="keyword">const</span> needTransition =</span><br><span class="line">    moveType !== <span class="title class_">MoveType</span>.<span class="property">REORDER</span> &amp;&amp;</span><br><span class="line">    shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span> &amp;&amp;</span><br><span class="line">    transition;</span><br><span class="line">  <span class="keyword">if</span> (needTransition) &#123;</span><br><span class="line">    <span class="keyword">if</span> (moveType === <span class="title class_">MoveType</span>.<span class="property">ENTER</span>) &#123;</span><br><span class="line">      transition!.<span class="title function_">beforeEnter</span>(el!);</span><br><span class="line">      <span class="title function_">hostInsert</span>(el!, container, anchor);</span><br><span class="line">      <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> transition!.<span class="title function_">enter</span>(el!), parentSuspense);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; leave, delayLeave, afterLeave &#125; = transition!;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">remove</span> = (<span class="params"></span>) =&gt; <span class="title function_">hostInsert</span>(el!, container, anchor);</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">performLeave</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">leave</span>(el!, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">remove</span>();</span><br><span class="line">          afterLeave &amp;&amp; <span class="title function_">afterLeave</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (delayLeave) &#123;</span><br><span class="line">        <span class="title function_">delayLeave</span>(el!, remove, performLeave);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">performLeave</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">hostInsert</span>(el!, container, anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="6-processElement"><a href="#6-processElement" class="headerlink" title="6. processElement"></a>6. <code>processElement</code></h3><h4 id="6-1-processElement"><a href="#6-1-processElement" class="headerlink" title="6.1 processElement"></a>6.1 <code>processElement</code></h4><p><code>processElement</code>å†…å®¹å¾ˆç®€å•ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¦å½“ä½œ<code>svg</code>å¤„ç†ï¼›ä¹‹åï¼Œå¦‚æœæ—§èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ç›´æ¥é€šè¿‡<code>mountElement</code>æŒ‚è½½æ–°çš„å…ƒç´ èŠ‚ç‚¹ï¼Œå¦åˆ™é€šè¿‡<code>patchElement</code>å¯¹å…ƒç´ èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">processElement</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n1: VNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  isSVG = isSVG || (n2.<span class="property">type</span> <span class="keyword">as</span> <span class="built_in">string</span>) === <span class="string">&quot;svg&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">mountElement</span>(</span><br><span class="line">      n2,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">patchElement</span>(</span><br><span class="line">      n1,</span><br><span class="line">      n2,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="6-2-mountElement"><a href="#6-2-mountElement" class="headerlink" title="6.2 mountElement"></a>6.2 <code>mountElement</code></h4><p>å‡å¦‚æ­¤æ—¶æ—§èŠ‚ç‚¹ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>mountElement</code>ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<ul>
<li>è‹¥<code>vndoe</code>ä¸Šçš„<code>el</code>å±æ€§å­˜åœ¨ï¼Œå¼€å‘ç¯å¢ƒä¸‹åˆ™ç®€å•å¯¹<code>el</code>è¿›è¡Œå¤åˆ¶ï¼›ä¸å­˜åœ¨åˆ™æ–°å»ºï¼›</li>
<li>å…ˆè¿›è¡Œå­èŠ‚ç‚¹çš„æŒ‚è½½ï¼Œå› ä¸ºæŸäº›<code>props</code>ä¾èµ–äºå­èŠ‚ç‚¹çš„æ¸²æŸ“ï¼›</li>
<li>æŒ‡ä»¤çš„<code>created</code>é˜¶æ®µï¼›</li>
<li>å¤„ç†<code>props</code>å¹¶è®¾ç½®<code>scopeId</code>ï¼›</li>
<li>å¼€å‘ç¯å¢ƒä¸‹è®¾ç½®<code>el.__vnode</code>å’Œ<code>el.vueParentComponent</code>çš„å–å€¼ï¼Œå¹¶è®¾ç½®ä¸ºä¸å¯æšä¸¾ï¼›</li>
<li>æŒ‡ä»¤çš„<code>beforeMounted</code>é˜¶æ®µï¼›</li>
<li>åŠ¨ç”»ç»„ä»¶<code>Transition</code>çš„<code>beforeEnter</code>é’©å­ï¼›</li>
<li>æ‰§è¡Œ<code>vnode</code>ä¸Šçš„é’©å­ã€<code>Transition</code>çš„<code>enter</code>é’©å­ã€æŒ‡ä»¤çš„<code>mounted</code>é’©å­ç­‰</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mountElement</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  vnode: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">el</span>: <span class="title class_">RendererElement</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">undefined</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, props, shapeFlag, transition, patchFlag, dirs &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !__DEV__ &amp;&amp;</span><br><span class="line">    vnode.<span class="property">el</span> &amp;&amp;</span><br><span class="line">    hostCloneNode !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">    patchFlag === <span class="title class_">PatchFlags</span>.<span class="property">HOISTED</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// vnodeçš„elå…ƒç´ å­˜åœ¨ï¼Œä»…åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¯¹å¯å¤ç”¨çš„é™æ€èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶</span></span><br><span class="line">    <span class="comment">// If a vnode has non-null el, it means it&#x27;s being reused.</span></span><br><span class="line">    <span class="comment">// Only static vnodes can be reused, so its mounted DOM nodes should be</span></span><br><span class="line">    <span class="comment">// exactly the same, and we can simply do a clone here.</span></span><br><span class="line">    <span class="comment">// only do this in production since cloned trees cannot be HMR updated.</span></span><br><span class="line">    el = vnode.<span class="property">el</span> = <span class="title function_">hostCloneNode</span>(vnode.<span class="property">el</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// vnodeä¸Šçš„å…ƒç´ ä¸å­˜åœ¨åˆ™æ–°å»º</span></span><br><span class="line">    el = vnode.<span class="property">el</span> = <span class="title function_">hostCreateElement</span>(</span><br><span class="line">      vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">      isSVG,</span><br><span class="line">      props &amp;&amp; props.<span class="property">is</span>,</span><br><span class="line">      props</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨é‡Šï¼šç”±äºæŸäº›propsä¾èµ–äºå­èŠ‚ç‚¹çš„æ¸²æŸ“ï¼Œå…ˆæŒ‚è½½å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// mount children first, since some props may rely on child content</span></span><br><span class="line">    <span class="comment">// being already rendered, e.g. `&lt;select value&gt;`</span></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®å…ƒç´ æ–‡æœ¬</span></span><br><span class="line">      <span class="title function_">hostSetElementText</span>(el, vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// æŒ‚è½½å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="title function_">mountChildren</span>(</span><br><span class="line">        vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">        el,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG &amp;&amp; <span class="keyword">type</span> !== <span class="string">&quot;foreignObject&quot;</span>,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡ä»¤çš„createdé˜¶æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (dirs) &#123;</span><br><span class="line">      <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&quot;created&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å…ƒç´ çš„props</span></span><br><span class="line">    <span class="comment">// props</span></span><br><span class="line">    <span class="keyword">if</span> (props) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key !== <span class="string">&quot;value&quot;</span> &amp;&amp; !<span class="title function_">isReservedProp</span>(key)) &#123;</span><br><span class="line">          <span class="title function_">hostPatchProp</span>(</span><br><span class="line">            el,</span><br><span class="line">            key,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            props[key],</span><br><span class="line">            isSVG,</span><br><span class="line">            vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            unmountChildren</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Special case for setting value on DOM elements:</span></span><br><span class="line"><span class="comment">       * - it can be order-sensitive (e.g. should be set *after* min/max, #2325, #4024)</span></span><br><span class="line"><span class="comment">       * - it needs to be forced (#1471)</span></span><br><span class="line"><span class="comment">       * #2353 proposes adding another renderer option to configure this, but</span></span><br><span class="line"><span class="comment">       * the properties affects are so finite it is worth special casing it</span></span><br><span class="line"><span class="comment">       * here to reduce the complexity. (Special casing it also should not</span></span><br><span class="line"><span class="comment">       * affect non-DOM renderers)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;value&quot;</span> <span class="keyword">in</span> props) &#123;</span><br><span class="line">        <span class="title function_">hostPatchProp</span>(el, <span class="string">&quot;value&quot;</span>, <span class="literal">null</span>, props.<span class="property">value</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = props.<span class="property">onVnodeBeforeMount</span>)) &#123;</span><br><span class="line">        <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// scopeId</span></span><br><span class="line">    <span class="title function_">setScopeId</span>(el, vnode, vnode.<span class="property">scopeId</span>, slotScopeIds, parentComponent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// __DEV__ç¯å¢ƒä¸‹å¤„ç† __vnodeå±æ€§å’Œçˆ¶ç»„ä»¶ä¸ºä¸å¯æšä¸¾</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(el, <span class="string">&quot;__vnode&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">value</span>: vnode,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(el, <span class="string">&quot;__vueParentComponent&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">value</span>: parentComponent,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‰§è¡ŒæŒ‡ä»¤ä¸­çš„ beforeMount é˜¶æ®µ</span></span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123;</span><br><span class="line">    <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&quot;beforeMount&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// #1583 For inside suspense + suspense not resolved case, enter hook should call when suspense resolved</span></span><br><span class="line">  <span class="comment">// #1689 For inside suspense + suspense resolved case, just call it</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦æ‰§è¡ŒåŠ¨ç”»ç»„ä»¶é’©å­</span></span><br><span class="line">  <span class="keyword">const</span> needCallTransitionHooks =</span><br><span class="line">    (!parentSuspense || (parentSuspense &amp;&amp; !parentSuspense.<span class="property">pendingBranch</span>)) &amp;&amp;</span><br><span class="line">    transition &amp;&amp;</span><br><span class="line">    !transition.<span class="property">persisted</span>;</span><br><span class="line">  <span class="keyword">if</span> (needCallTransitionHooks) &#123;</span><br><span class="line">    transition!.<span class="title function_">beforeEnter</span>(el);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">hostInsert</span>(el, container, anchor);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeMounted</span>) ||</span><br><span class="line">    needCallTransitionHooks ||</span><br><span class="line">    dirs</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// åŠ å…¥ç»„ä»¶æ›´æ–°åçš„å‰¯ä½œç”¨æ‰§è¡Œé˜Ÿåˆ—ï¼Œåœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œå…¥é˜Ÿçš„å‡½æ•°</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸€äº›é’©å­å‡½æ•°ã€trasitionçš„é’©å­ã€æŒ‡ä»¤åœ¨mountedé˜¶æ®µçš„é’©å­</span></span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vnodeHook &amp;&amp; <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode);</span><br><span class="line">      needCallTransitionHooks &amp;&amp; transition!.<span class="title function_">enter</span>(el);</span><br><span class="line">      dirs &amp;&amp; <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&quot;mounted&quot;</span>);</span><br><span class="line">    &#125;, parentSuspense);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="6-3-patchElement"><a href="#6-3-patchElement" class="headerlink" title="6.3 patchElement"></a>6.3 <code>patchElement</code></h4><p><code>patchElemengt</code>ç›¸å½“é‡è¦ï¼Œå› ä¸ºå…¶å®ƒå’Œä½ å¤šå†…å®¹çš„<code>patch</code>ï¼Œæœ€ç»ˆç»è¿‡é€’å½’ï¼Œä¾ç„¶ä¼šèµ°åˆ°<code>patchElement</code>ã€‚å½“æ–°æ—§å…ƒç´ èŠ‚ç‚¹éƒ½å­˜åœ¨æ—¶ï¼Œå°±ä¼šè°ƒç”¨<code>patchElement</code>è¿›è¡Œå¯¹æ¯”ã€‚å¯ä»¥çœ‹åˆ°é¡ºåºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beforeUpdated -&gt; å­èŠ‚ç‚¹ -&gt; class/style -&gt; å…¶å®ƒprops/attrs -&gt; updated</span><br></pre></td></tr></table></figure>
<ul>
<li><p>å…³é—­<code>recurse</code>ï¼Œå¤„ç†<code>beforeUpdated</code>é’©å­ï¼›</p>
</li>
<li><p>å¤„ç†æŒ‡å®šçš„<code>beforeUpdated</code>é˜¶æ®µï¼Œå†å¯ç”¨<code>recurse</code>ï¼›</p>
</li>
<li><p>åœ¨<code>__DEV__</code>ç¯å¢ƒä¸‹çš„çƒ­æ›´æ–°æ—¶ï¼Œåˆ™ä¼šæ¸…ç†ä¼˜åŒ–æ ‡è®°ï¼Œä»è€Œå¼ºåˆ¶å¯¹èŠ‚ç‚¹è¿›è¡Œå…¨é‡çš„æ¯”è¾ƒ(<code>full diff</code>)ï¼›</p>
</li>
<li><p>å¤„ç†åŠ¨æ€å­èŠ‚ç‚¹ï¼š</p>
<ul>
<li>å½“æ–°èŠ‚ç‚¹ä¸­æœ‰åŠ¨æ€å­èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡<code>patchBlockChildren</code>æ¥å’Œæ—§èŠ‚ç‚¹çš„åŠ¨æ€å­èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”ï¼›</li>
<li>å¦åˆ™ï¼Œå¦‚æœæ²¡æœ‰ä¼˜åŒ–(<code>!optimized</code>)ï¼Œåˆ™ä½¿ç”¨<code>patchChildren</code>å¯¹å­èŠ‚ç‚¹è¿›è¡Œå…¨é‡<code>diff</code>ï¼›</li>
</ul>
</li>
<li><p>åˆ¤æ–­<code>patchFlag &gt; 0</code>ï¼Œå¤§äº<code>0</code>æ—¶åˆ™å…ƒç´ çš„<code>render</code>ä»£ç ç”±<code>compiler</code>ç”Ÿæˆï¼Œæœ‰ä¼˜åŒ–<code>buff</code>ï¼š</p>
<ul>
<li>å¦‚æœ<code>props</code>ä¸­æœ‰åŠ¨æ€çš„<code>key</code>ï¼Œåˆ™ä¼˜åŒ–æ— æ•ˆï¼Œè¿›è¡Œå…¨é‡<code>diff</code>ï¼›</li>
<li>å¤„ç†åŠ¨æ€ç±»åå’ŒåŠ¨æ€<code>style</code>ï¼Œä¼˜åŒ–<code>diff</code>ï¼›</li>
<li>å¤„ç†å…¶å®ƒçš„<code>prop/attr</code>ï¼Œå¦‚æœå…¶ä¸­æœ‰åŠ¨æ€çš„<code>key</code>ï¼Œåˆ™ä¼˜åŒ–æ— æ•ˆï¼›</li>
<li>å¤„ç†æ–‡æœ¬ï¼šå½“å…ƒç´ åªæœ‰æ–‡æœ¬å­èŠ‚ç‚¹æ—¶ï¼Œåˆ™å°†æ–‡æœ¬å­èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å…ƒç´ èŠ‚ç‚¹çš„å†…å®¹ï¼›</li>
</ul>
</li>
<li><p><code>patchFlag &lt;= 0</code>ï¼Œä¸”æ²¡æœ‰è®¾ç½®ä¼˜åŒ–æ—¶ï¼Œå¯¹<code>props</code>è¿›è¡Œå…¨é‡<code>diff</code>ï¼›</p>
</li>
<li><p><code>updated</code>é˜¶æ®µã€‚</p>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patchElement</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n1: VNode,</span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> el = (n2.<span class="property">el</span> = n1.<span class="property">el</span>!);</span><br><span class="line">  <span class="keyword">let</span> &#123; patchFlag, dynamicChildren, dirs &#125; = n2;</span><br><span class="line">  <span class="comment">// #1426 take the old vnode&#x27;s patch flag into account since user may clone a</span></span><br><span class="line">  <span class="comment">// compiler-generated vnode, which de-opts to FULL_PROPS</span></span><br><span class="line">  patchFlag |= n1.<span class="property">patchFlag</span> &amp; <span class="title class_">PatchFlags</span>.<span class="property">FULL_PROPS</span>;</span><br><span class="line">  <span class="keyword">const</span> oldProps = n1.<span class="property">props</span> || <span class="variable constant_">EMPTY_OBJ</span>;</span><br><span class="line">  <span class="keyword">const</span> newProps = n2.<span class="property">props</span> || <span class="variable constant_">EMPTY_OBJ</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">undefined</span> | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…³é—­recurseï¼Œåœ¨ beforeUpdated é˜¶æ®µä¸å…è®¸è‡ªå·±è°ƒç”¨</span></span><br><span class="line">  <span class="comment">// disable recurse in beforeUpdate hooks</span></span><br><span class="line">  parentComponent &amp;&amp; <span class="title function_">toggleRecurse</span>(parentComponent, <span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// beforeUpdatedé’©å­</span></span><br><span class="line">  <span class="keyword">if</span> ((vnodeHook = newProps.<span class="property">onVnodeBeforeUpdate</span>)) &#123;</span><br><span class="line">    <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, n2, n1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æŒ‡ä»¤çš„ beforeUpdated é’©å­</span></span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123;</span><br><span class="line">    <span class="title function_">invokeDirectiveHook</span>(n2, n1, parentComponent, <span class="string">&quot;beforeUpdate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…è®¸è‡ªå·±è°ƒç”¨</span></span><br><span class="line">  parentComponent &amp;&amp; <span class="title function_">toggleRecurse</span>(parentComponent, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å‘ç¯å¢ƒå‘¢ä¸‹ï¼Œå…³é—­ä¼˜åŒ–ï¼Œå…¨é‡diff</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; isHmrUpdating) &#123;</span><br><span class="line">    <span class="comment">// HMR updated, force full diff</span></span><br><span class="line">    patchFlag = <span class="number">0</span>;</span><br><span class="line">    optimized = <span class="literal">false</span>;</span><br><span class="line">    dynamicChildren = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> areChildrenSVG = isSVG &amp;&amp; n2.<span class="property">type</span> !== <span class="string">&quot;foreignObject&quot;</span>;</span><br><span class="line">  <span class="comment">// æ–°èŠ‚ç‚¹çš„åŠ¨æ€å­èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹çš„åŠ¨æ€å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicChildren) &#123;</span><br><span class="line">    <span class="title function_">patchBlockChildren</span>(</span><br><span class="line">      n1.<span class="property">dynamicChildren</span>!,</span><br><span class="line">      dynamicChildren,</span><br><span class="line">      el,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      areChildrenSVG,</span><br><span class="line">      slotScopeIds</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// å¼€å‘ç¯å¢ƒ  é€’å½’éå†é™æ€å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; parentComponent &amp;&amp; parentComponent.<span class="property">type</span>.<span class="property">__hmrId</span>) &#123;</span><br><span class="line">      <span class="title function_">traverseStaticChildren</span>(n1, n2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡æœ‰ä¼˜åŒ–ï¼Œå…¨é‡ diff</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!optimized) &#123;</span><br><span class="line">    <span class="comment">// full diff</span></span><br><span class="line">    <span class="title function_">patchChildren</span>(</span><br><span class="line">      n1,</span><br><span class="line">      n2,</span><br><span class="line">      el,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      areChildrenSVG,</span><br><span class="line">      slotScopeIds,</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨é‡Šï¼špatchFlag æ ‡è¯†çš„å­˜åœ¨æ„å‘³ç€å…ƒç´ çš„ render ä»£ç æ˜¯ç”± compiler ç”Ÿæˆçš„ï¼Œ</span></span><br><span class="line">  <span class="comment">// ä¸”å¯ä»¥åœ¨ patch æ—¶èµ°å¿«é“ï¼Œæ­¤æ—¶èƒ½ä¿è¯æ–°æ—§èŠ‚ç‚¹å½¢çŠ¶ç›¸åŒï¼Œå³å®ƒä»¬åœ¨æºæ¨¡æ¿ä¸­æ­£å¥½å¤„äºç›¸åŒçš„ä½ç½®</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶çš„å¯¹æ¯”æ˜¯æœ‰ç€å„ç§ä¼˜åŒ–çš„</span></span><br><span class="line">  <span class="keyword">if</span> (patchFlag &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// the presence of a patchFlag means this element&#x27;s render code was</span></span><br><span class="line">    <span class="comment">// generated by the compiler and can take the fast path.</span></span><br><span class="line">    <span class="comment">// in this path old node and new node are guaranteed to have the same shape</span></span><br><span class="line">    <span class="comment">// (i.e. at the exact same position in the source template)</span></span><br><span class="line">    <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">FULL_PROPS</span>) &#123;</span><br><span class="line">      <span class="comment">// å½“propsä¸­å«æœ‰åŠ¨æ€çš„keyï¼Œéœ€è¦è¿›è¡Œå…¨é‡ diff</span></span><br><span class="line">      <span class="comment">// element props contain dynamic keys, full diff needed</span></span><br><span class="line">      <span class="title function_">patchProps</span>(</span><br><span class="line">        el,</span><br><span class="line">        n2,</span><br><span class="line">        oldProps,</span><br><span class="line">        newProps,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¤„ç†åŠ¨æ€ç±»åç»‘å®š</span></span><br><span class="line">      <span class="comment">// class</span></span><br><span class="line">      <span class="comment">// this flag is matched when the element has dynamic class bindings.</span></span><br><span class="line">      <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">CLASS</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldProps.<span class="property">class</span> !== newProps.<span class="property">class</span>) &#123;</span><br><span class="line">          <span class="title function_">hostPatchProp</span>(el, <span class="string">&quot;class&quot;</span>, <span class="literal">null</span>, newProps.<span class="property">class</span>, isSVG);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤„ç†åŠ¨æ€çš„ style ç»‘å®š</span></span><br><span class="line">      <span class="comment">// style</span></span><br><span class="line">      <span class="comment">// this flag is matched when the element has dynamic style bindings</span></span><br><span class="line">      <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">STYLE</span>) &#123;</span><br><span class="line">        <span class="title function_">hostPatchProp</span>(el, <span class="string">&quot;style&quot;</span>, oldProps.<span class="property">style</span>, newProps.<span class="property">style</span>, isSVG);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¤„ç†åŠ¨æ€çš„ prop/attr ç»‘å®šï¼Œæœ‰è¿­ä»£ç¼“å­˜ï¼Œä¼˜åŒ–æ¯”è¾ƒé€Ÿåº¦</span></span><br><span class="line">      <span class="comment">// å¦‚æœ `prop/attr`çš„ key æ˜¯åŠ¨æ€çš„ï¼Œé‚£ä¹ˆè¿™ç§ä¼˜åŒ–åˆ™ä¼šå¤±æ•ˆ</span></span><br><span class="line">      <span class="comment">// props</span></span><br><span class="line">      <span class="comment">// This flag is matched when the element has dynamic prop/attr bindings</span></span><br><span class="line">      <span class="comment">// other than class and style. The keys of dynamic prop/attrs are saved for</span></span><br><span class="line">      <span class="comment">// faster iteration.</span></span><br><span class="line">      <span class="comment">// Note dynamic keys like :[foo]=&quot;bar&quot; will cause this optimization to</span></span><br><span class="line">      <span class="comment">// bail out and go through a full diff because we need to unset the old key</span></span><br><span class="line">      <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">PROPS</span>) &#123;</span><br><span class="line">        <span class="comment">// if the flag is present then dynamicProps must be non-null</span></span><br><span class="line">        <span class="keyword">const</span> propsToUpdate = n2.<span class="property">dynamicProps</span>!;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; propsToUpdate.<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> key = propsToUpdate[i];</span><br><span class="line">          <span class="keyword">const</span> prev = oldProps[key];</span><br><span class="line">          <span class="keyword">const</span> next = newProps[key];</span><br><span class="line">          <span class="comment">// valueå±æ€§ä¼šè¢«å¼ºè¡Œå¯¹æ¯”</span></span><br><span class="line">          <span class="comment">// #1471 force patch value</span></span><br><span class="line">          <span class="keyword">if</span> (next !== prev || key === <span class="string">&quot;value&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">hostPatchProp</span>(</span><br><span class="line">              el,</span><br><span class="line">              key,</span><br><span class="line">              prev,</span><br><span class="line">              next,</span><br><span class="line">              isSVG,</span><br><span class="line">              n1.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">              parentComponent,</span><br><span class="line">              parentSuspense,</span><br><span class="line">              unmountChildren</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ–‡æœ¬ï¼šä»…åœ¨å…ƒç´ åªæœ‰æ–‡æœ¬å­èŠ‚ç‚¹æ—¶è§¦å‘</span></span><br><span class="line">    <span class="comment">// text</span></span><br><span class="line">    <span class="comment">// This flag is matched when the element has only dynamic text children.</span></span><br><span class="line">    <span class="keyword">if</span> (patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">TEXT</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (n1.<span class="property">children</span> !== n2.<span class="property">children</span>) &#123;</span><br><span class="line">        <span class="title function_">hostSetElementText</span>(el, n2.<span class="property">children</span> <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!optimized &amp;&amp; dynamicChildren == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰ä¼˜åŒ–ï¼Œå…¨é‡ diff</span></span><br><span class="line">    <span class="comment">// unoptimized, full diff</span></span><br><span class="line">    <span class="title function_">patchProps</span>(</span><br><span class="line">      el,</span><br><span class="line">      n2,</span><br><span class="line">      oldProps,</span><br><span class="line">      newProps,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// updated é’©å­ å…¥é˜Ÿ</span></span><br><span class="line">  <span class="keyword">if</span> ((vnodeHook = newProps.<span class="property">onVnodeUpdated</span>) || dirs) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vnodeHook &amp;&amp; <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, n2, n1);</span><br><span class="line">      dirs &amp;&amp; <span class="title function_">invokeDirectiveHook</span>(n2, n1, parentComponent, <span class="string">&quot;updated&quot;</span>);</span><br><span class="line">    &#125;, parentSuspense);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>patchElement</code>ä¸­ï¼Œæ³¨æ„åˆ°å½“æ–°èŠ‚ç‚¹å…·æœ‰åŠ¨æ€å­èŠ‚ç‚¹æ—¶ï¼Œè°ƒç”¨äº†<code>patchBlockChildren</code>æ¥è¿›è¡Œå­èŠ‚ç‚¹çš„æ¯”è¾ƒï¼Œè€Œåœ¨æ²¡æœ‰åŠ¨æ€å­èŠ‚ç‚¹ä¸”ä¸ç¬¦åˆä¼˜åŒ–æ¡ä»¶æ—¶ï¼Œåˆ™ä½¿ç”¨<code>patchChildren</code>æ¥æ¯”è¾ƒã€‚è¿™ä¸<code>processFragment</code>ç±»ä¼¼ã€‚</p>
<p>è€Œå½“<code>patchFlag &lt;= 0</code>ä¸”æ²¡æœ‰è®¾ç½®ä¼˜åŒ–æ—¶ï¼Œå¯¹<code>props</code>è¿›è¡Œå…¨é‡<code>diff</code>ã€‚åˆ†åˆ«éå†æ–°çš„<code>props</code>å’Œæ—§çš„<code>props</code>ï¼Œæœ€ååˆ·æ–°<code>value</code>çš„å€¼ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patchProps</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  el: RendererElement,</span></span><br><span class="line"><span class="params">  vnode: VNode,</span></span><br><span class="line"><span class="params">  oldProps: Data,</span></span><br><span class="line"><span class="params">  newProps: Data,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldProps !== newProps) &#123;</span><br><span class="line">    <span class="comment">// éå†æ–°çš„props</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">      <span class="comment">// empty string is not valid prop</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isReservedProp</span>(key)) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">const</span> next = newProps[key];</span><br><span class="line">      <span class="keyword">const</span> prev = oldProps[key];</span><br><span class="line">      <span class="comment">// å…ˆä¸æ¯”è¾ƒ value</span></span><br><span class="line">      <span class="comment">// defer patching value</span></span><br><span class="line">      <span class="keyword">if</span> (next !== prev &amp;&amp; key !== <span class="string">&quot;value&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">hostPatchProp</span>(</span><br><span class="line">          el,</span><br><span class="line">          key,</span><br><span class="line">          prev,</span><br><span class="line">          next,</span><br><span class="line">          isSVG,</span><br><span class="line">          vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          unmountChildren</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éå†æ—§çš„props</span></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== <span class="variable constant_">EMPTY_OBJ</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isReservedProp</span>(key) &amp;&amp; !(key <span class="keyword">in</span> newProps)) &#123;</span><br><span class="line">          <span class="title function_">hostPatchProp</span>(</span><br><span class="line">            el,</span><br><span class="line">            key,</span><br><span class="line">            oldProps[key],</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            isSVG,</span><br><span class="line">            vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[],</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            unmountChildren</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ€åå¤„ç† value</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;value&quot;</span> <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">      <span class="title function_">hostPatchProp</span>(el, <span class="string">&quot;value&quot;</span>, oldProps.<span class="property">value</span>, newProps.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="7-processComponent"><a href="#7-processComponent" class="headerlink" title="7. processComponent"></a>7. <code>processComponent</code></h3><h4 id="7-1-processComponent"><a href="#7-1-processComponent" class="headerlink" title="7.1 processComponent"></a>7.1 <code>processComponent</code></h4><p>å½“è¢«<code>patch</code>çš„èŠ‚ç‚¹ç±»å‹æ˜¯ç»„ä»¶æ—¶ï¼Œé€šè¿‡<code>processComponent</code>æ¥å¤„ç†ã€‚</p>
<ul>
<li><p>å½“æ—§ç»„ä»¶èŠ‚ç‚¹å­˜åœ¨æ—¶ï¼Œåˆ™è°ƒç”¨<code>updateComponent</code>è¿›è¡Œæ›´æ–°ï¼›</p>
</li>
<li><p>å¦åˆ™ï¼š</p>
<ul>
<li>å½“æ–°ç»„ä»¶èŠ‚ç‚¹ä¸º<code>KeepAlive</code>æ—¶ï¼Œè°ƒç”¨å…¶ä¸Šä¸‹æ–‡å¯¹è±¡ä¸Šçš„<code>activate</code>æ–¹æ³•ï¼›</li>
<li>å¦åˆ™ï¼Œä½¿ç”¨<code>mountComponent</code>æŒ‚è½½æ–°çš„ç»„ä»¶èŠ‚ç‚¹ï¼›</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">processComponent</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  n1: VNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  n2: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  n2.<span class="property">slotScopeIds</span> = slotScopeIds;</span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n2.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_KEPT_ALIVE</span>) &#123;</span><br><span class="line">      (parentComponent!.<span class="property">ctx</span> <span class="keyword">as</span> <span class="title class_">KeepAliveContext</span>).<span class="title function_">activate</span>(</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">mountComponent</span>(</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">updateComponent</span>(n1, n2, optimized);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-mountComponent"><a href="#7-2-mountComponent" class="headerlink" title="7.2 mountComponent"></a>7.2 <code>mountComponent</code></h4><p><code>mountComponent</code>åœ¨æ—§çš„ç»„ä»¶èŠ‚ç‚¹ä¸å­˜åœ¨æ—¶è¢«è°ƒç”¨ã€‚æ‰€æœ‰çš„<code>mountXXX</code>æœ€å¸¸è§çš„è°ƒç”¨æ—¶æœºéƒ½æ˜¯é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œæ—§èŠ‚ç‚¹éƒ½æ˜¯ç©ºçš„ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">mountComponent</span>: <span class="title class_">MountComponentFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  initialVNode,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 2.x compat may pre-create the component instance before actually</span></span><br><span class="line">  <span class="comment">// mounting</span></span><br><span class="line">  <span class="keyword">const</span> compatMountInstance =</span><br><span class="line">    __COMPAT__ &amp;&amp; initialVNode.<span class="property">isCompatRoot</span> &amp;&amp; initialVNode.<span class="property">component</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">instance</span>: <span class="title class_">ComponentInternalInstance</span> =</span><br><span class="line">    compatMountInstance ||</span><br><span class="line">    (initialVNode.<span class="property">component</span> = <span class="title function_">createComponentInstance</span>(</span><br><span class="line">      initialVNode,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œçƒ­æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; instance.<span class="property">type</span>.<span class="property">__hmrId</span>) &#123;</span><br><span class="line">    <span class="title function_">registerHMR</span>(instance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŒ‚è½½æ€§èƒ½æ£€æµ‹</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">pushWarningContext</span>(initialVNode);</span><br><span class="line">    <span class="title function_">startMeasure</span>(instance, <span class="string">`mount`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å…¥rendererçš„å†…éƒ¨å†…å®¹</span></span><br><span class="line">  <span class="comment">// inject renderer internals for keepAlive</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isKeepAlive</span>(initialVNode)) &#123;</span><br><span class="line">    (instance.<span class="property">ctx</span> <span class="keyword">as</span> <span class="title class_">KeepAliveContext</span>).<span class="property">renderer</span> = internals;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** è¿™é‡Œå¤‡æ³¨ä¸€ä¸‹ internals çš„å†…å®¹</span></span><br><span class="line"><span class="comment">   * const internals: RendererInternals = &#123;</span></span><br><span class="line"><span class="comment">   *   p: patch,</span></span><br><span class="line"><span class="comment">   *   um: unmount,</span></span><br><span class="line"><span class="comment">   *   m: move,</span></span><br><span class="line"><span class="comment">   *   r: remove,</span></span><br><span class="line"><span class="comment">   *   mt: mountComponent,</span></span><br><span class="line"><span class="comment">   *   mc: mountChildren,</span></span><br><span class="line"><span class="comment">   *   pc: patchChildren,</span></span><br><span class="line"><span class="comment">   *   pbc: patchBlockChildren,</span></span><br><span class="line"><span class="comment">   *   n: getNextHostNode,</span></span><br><span class="line"><span class="comment">   *   o: options</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†propså’Œæ’æ§½</span></span><br><span class="line">  <span class="comment">// resolve props and slots for setup context</span></span><br><span class="line">  <span class="keyword">if</span> (!(__COMPAT__ &amp;&amp; compatMountInstance)) &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹åˆå§‹åŒ–æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">startMeasure</span>(instance, <span class="string">`init`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†setupï¼šè¿™ä¸ªå‡½æ•°é‡Œä½¿ç”¨å…¶å®ƒæ–¹æ³•ï¼Œåˆå§‹åŒ–äº†propså’Œæ’æ§½ï¼Œä¸”è°ƒç”¨äº†setup</span></span><br><span class="line">    <span class="title function_">setupComponent</span>(instance);</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">endMeasure</span>(instance, <span class="string">`init`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å¼‚æ­¥çš„setup</span></span><br><span class="line">  <span class="comment">// setup() is async. This component relies on async logic to be resolved</span></span><br><span class="line">  <span class="comment">// before proceeding</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; instance.<span class="property">asyncDep</span>) &#123;</span><br><span class="line">    parentSuspense &amp;&amp; parentSuspense.<span class="title function_">registerDep</span>(instance, setupRenderEffect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Give it a placeholder if this is not hydration</span></span><br><span class="line">    <span class="comment">// TODO handle self-defined fallback</span></span><br><span class="line">    <span class="keyword">if</span> (!initialVNode.<span class="property">el</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> placeholder = (instance.<span class="property">subTree</span> = <span class="title function_">createVNode</span>(<span class="title class_">Comment</span>));</span><br><span class="line">      <span class="title function_">processCommentNode</span>(<span class="literal">null</span>, placeholder, container!, anchor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¥ä¸‹æ¥æ ¹æ®setupè¿”å›å†…å®¹è¿›è¡Œæ¸²æŸ“</span></span><br><span class="line">  <span class="comment">// todo é˜…è¯»è¯¥å‡½æ•°çš„å†…å®¹</span></span><br><span class="line">  <span class="title function_">setupRenderEffect</span>(</span><br><span class="line">    instance,</span><br><span class="line">    initialVNode,</span><br><span class="line">    container,</span><br><span class="line">    anchor,</span><br><span class="line">    parentSuspense,</span><br><span class="line">    isSVG,</span><br><span class="line">    optimized</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mountæ€§èƒ½æ£€æµ‹ç»“æŸç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">popWarningContext</span>();</span><br><span class="line">    <span class="title function_">endMeasure</span>(instance, <span class="string">`mount`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="7-3-updateComponent"><a href="#7-3-updateComponent" class="headerlink" title="7.3 updateComponent"></a>7.3 <code>updateComponent</code></h4><p>å½“æ—§çš„ç»„ä»¶èŠ‚ç‚¹å­˜åœ¨æ—¶ï¼Œå¯¹ç»„ä»¶èŠ‚ç‚¹çš„å¤„ç†ä¼šè¿›å…¥åˆ°æ›´æ–°é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯<code>updateComponent</code>ã€‚ä»¥æ—§ç»„ä»¶ä¸ºåŸºå‡†æ‹¿åˆ°å®ä¾‹<code>instance</code>ï¼Œé€šè¿‡<code>shouldUpdateComponent</code>åˆ¤æ–­æ˜¯å¦è¦æ›´æ–°ç»„ä»¶ã€‚å¦‚æœä¸éœ€è¦æ›´æ–°ï¼Œåˆ™åªå¤åˆ¶ä¸€ä¸‹å±æ€§ï¼›å¦åˆ™ï¼Œå½“å®ä¾‹æ˜¯å¼‚æ­¥ç»„ä»¶æ—¶ï¼Œåˆ™åªæ›´æ–°<code>props</code>å’Œæ’æ§½ï¼›å½“å®ä¾‹æ˜¯åŒæ­¥ç»„ä»¶æ—¶ï¼Œåˆ™è®¾ç½®<code>next</code>ä¸ºæ–°çš„ç»„ä»¶èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ç»„ä»¶çš„<code>update</code>æ–¹æ³•è¿›è¡Œæ›´æ–°ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">updateComponent</span> = (<span class="params">n1: VNode, n2: VNode, optimized: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = (n2.<span class="property">component</span> = n1.<span class="property">component</span>)!;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">shouldUpdateComponent</span>(n1, n2, optimized)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; instance.<span class="property">asyncDep</span> &amp;&amp; !instance.<span class="property">asyncResolved</span>) &#123;</span><br><span class="line">      <span class="comment">// async &amp; still pending - just update props and slots</span></span><br><span class="line">      <span class="comment">// since the component&#x27;s reactive effect for render isn&#x27;t set-up yet</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">pushWarningContext</span>(n2);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°ç»„ä»¶çš„é¢„æ¸²æŸ“ï¼šå³å¤„ç†propså’Œæ’æ§½</span></span><br><span class="line">      <span class="title function_">updateComponentPreRender</span>(instance, n2, optimized);</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">popWarningContext</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// normal update</span></span><br><span class="line">      instance.<span class="property">next</span> = n2;</span><br><span class="line">      <span class="comment">// in case the child component is also queued, remove it to avoid</span></span><br><span class="line">      <span class="comment">// double updating the same child component in the same flush.</span></span><br><span class="line">      <span class="title function_">invalidateJob</span>(instance.<span class="property">update</span>);</span><br><span class="line">      <span class="comment">// instance.update is the reactive effect.</span></span><br><span class="line">      instance.<span class="title function_">update</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// no update needed. just copy over properties</span></span><br><span class="line">    n2.<span class="property">el</span> = n1.<span class="property">el</span>;</span><br><span class="line">    instance.<span class="property">vnode</span> = n2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="7-4-updateComponentPreRender"><a href="#7-4-updateComponentPreRender" class="headerlink" title="7.4 updateComponentPreRender"></a>7.4 <code>updateComponentPreRender</code></h4><p>ç»„ä»¶çš„é¢„æ¸²æŸ“ï¼Œå³åœ¨è¿™é‡Œå¤„ç†<code>props</code>å’Œæ’æ§½ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">updateComponentPreRender</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  nextVNode: VNode,</span></span><br><span class="line"><span class="params">  optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  nextVNode.<span class="property">component</span> = instance;</span><br><span class="line">  <span class="keyword">const</span> prevProps = instance.<span class="property">vnode</span>.<span class="property">props</span>;</span><br><span class="line">  instance.<span class="property">vnode</span> = nextVNode;</span><br><span class="line">  instance.<span class="property">next</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="title function_">updateProps</span>(instance, nextVNode.<span class="property">props</span>, prevProps, optimized);</span><br><span class="line">  <span class="title function_">updateSlots</span>(instance, nextVNode.<span class="property">children</span>, optimized);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">pauseTracking</span>();</span><br><span class="line">  <span class="comment">// props update may have triggered pre-flush watchers.</span></span><br><span class="line">  <span class="comment">// flush them before the render update.</span></span><br><span class="line">  <span class="title function_">flushPreFlushCbs</span>(<span class="literal">undefined</span>, instance.<span class="property">update</span>);</span><br><span class="line">  <span class="title function_">resetTracking</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="7-4-setupRenderEffect"><a href="#7-4-setupRenderEffect" class="headerlink" title="7.4 setupRenderEffect"></a>7.4 <code>setupRenderEffect</code></h4><p>ç›¸å½“é‡è¦çš„ä¸€ä¸ªå‡½æ•°ã€‚ç”¨<code>componentUpdateFn</code>æ¥åˆ›å»ºä¸€ä¸ª<code>effect</code>ã€‚æœ€åæ‰§è¡Œçš„<code>update</code>å‡½æ•°ä»¥åŠå®ä¾‹çš„<code>update</code>æ–¹æ³•ï¼Œéƒ½æ˜¯æ‰§è¡Œ<code>effect.run</code>ã€‚è€Œ<code>effect.run</code>å†…éƒ¨ä¼šè¿›è¡Œä¸ä¾èµ–æ”¶é›†ç›¸å…³çš„æ“ä½œï¼Œè¿˜ä¼šè°ƒç”¨æ–°å»º<code>effect</code>æ—¶ä¼ å…¥çš„å‡½æ•°<code>componentUpdateFn</code>ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°<strong><code>componentUpdateFn</code>åˆ†ä¸ºæŒ‚è½½å’Œæ›´æ–°ä¸¤éƒ¨åˆ†</strong>ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">setupRenderEffect</span>: <span class="title class_">SetupRenderEffectFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  initialVNode,</span></span></span><br><span class="line"><span class="params"><span class="function">  container,</span></span></span><br><span class="line"><span class="params"><span class="function">  anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">componentUpdateFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.<span class="property">isMounted</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">null</span> | <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">const</span> &#123; el, props &#125; = initialVNode;</span><br><span class="line">      <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance;</span><br><span class="line">      <span class="keyword">const</span> isAsyncWrapperVNode = <span class="title function_">isAsyncWrapper</span>(initialVNode);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åœ¨beforeMountedæœŸé—´ ä¸å…è®¸effectè‡ªå·±è°ƒç”¨</span></span><br><span class="line">      <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>);</span><br><span class="line">      <span class="comment">// beforeMount hook</span></span><br><span class="line">      <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">        <span class="title function_">invokeArrayFns</span>(bm);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeBeforeMount</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !isAsyncWrapperVNode &amp;&amp;</span><br><span class="line">        (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeBeforeMount</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, initialVNode);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        __COMPAT__ &amp;&amp;</span><br><span class="line">        <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:beforeMount&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (el &amp;&amp; hydrateNode) &#123;</span><br><span class="line">        <span class="comment">// vnode has adopted host node - perform hydration instead of mount.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">hydrateSubTree</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance);</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">startMeasure</span>(instance, <span class="string">`hydrate`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          hydrateNode!(</span><br><span class="line">            el <span class="keyword">as</span> <span class="title class_">Node</span>,</span><br><span class="line">            instance.<span class="property">subTree</span>,</span><br><span class="line">            instance,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">endMeasure</span>(instance, <span class="string">`hydrate`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isAsyncWrapperVNode) &#123;</span><br><span class="line">          (initialVNode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ComponentOptions</span>).<span class="property">__asyncLoader</span>!().<span class="title function_">then</span>(</span><br><span class="line">            <span class="comment">// note: we are moving the render call into an async callback,</span></span><br><span class="line">            <span class="comment">// which means it won&#x27;t track dependencies - but it&#x27;s ok because</span></span><br><span class="line">            <span class="comment">// a server-rendered async wrapper is already in resolved state</span></span><br><span class="line">            <span class="comment">// and it will never need to change.</span></span><br><span class="line">            <span class="function">() =&gt;</span> !instance.<span class="property">isUnmounted</span> &amp;&amp; <span class="title function_">hydrateSubTree</span>()</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">hydrateSubTree</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> subTree = (instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance));</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">startMeasure</span>(instance, <span class="string">`patch`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          subTree,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">endMeasure</span>(instance, <span class="string">`patch`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// mountedé’©å­å…¥é˜Ÿ</span></span><br><span class="line">      <span class="comment">// mounted hook</span></span><br><span class="line">      <span class="keyword">if</span> (m) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(m, parentSuspense);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeMounted</span></span><br><span class="line">      <span class="keyword">if</span> (!isAsyncWrapperVNode &amp;&amp; (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeMounted</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopedInitialVNode = initialVNode;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">          <span class="function">() =&gt;</span> <span class="title function_">invokeVNodeHook</span>(vnodeHook!, parent, scopedInitialVNode),</span><br><span class="line">          parentSuspense</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        __COMPAT__ &amp;&amp;</span><br><span class="line">        <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">          <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:mounted&quot;</span>),</span><br><span class="line">          parentSuspense</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// &lt;KeepAlive&gt;ç»„ä»¶çš„activatedé’©å­ï¼Œå¯èƒ½åŒ…å«ä»å­ç»„ä»¶æ³¨å…¥çš„é’©å­</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// activated hook for keep-alive roots.</span></span><br><span class="line">      <span class="comment">// #1742 activated hook must be accessed after first render</span></span><br><span class="line">      <span class="comment">// since the hook may be injected by a child keep-alive</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        initialVNode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span> ||</span><br><span class="line">        (parent &amp;&amp;</span><br><span class="line">          <span class="title function_">isAsyncWrapper</span>(parent.<span class="property">vnode</span>) &amp;&amp;</span><br><span class="line">          parent.<span class="property">vnode</span>.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        instance.<span class="property">a</span> &amp;&amp; <span class="title function_">queuePostRenderEffect</span>(instance.<span class="property">a</span>, parentSuspense);</span><br><span class="line">        <span class="comment">// å…¼å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">            <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:activated&quot;</span>),</span><br><span class="line">            parentSuspense</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å˜æ›´ç»„ä»¶æŒ‚è½½çŠ¶æ€</span></span><br><span class="line">      instance.<span class="property">isMounted</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">        <span class="title function_">devtoolsComponentAdded</span>(instance);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// #2458: deference mount-only object parameters to prevent memleaks</span></span><br><span class="line">      initialVNode = container = anchor = <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// updateComponent</span></span><br><span class="line">      <span class="comment">// This is triggered by mutation of component&#x27;s own state (next: null)</span></span><br><span class="line">      <span class="comment">// OR parent calling processComponent (next: VNode)</span></span><br><span class="line">      <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance;</span><br><span class="line">      <span class="keyword">let</span> originNext = next;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">null</span> | <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">pushWarningContext</span>(next || instance.<span class="property">vnode</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// beforeUpdated æœŸé—´ä¹Ÿä¸å…è®¸effectè‡ªè°ƒç”¨</span></span><br><span class="line">      <span class="comment">// Disallow component effect recursion during pre-lifecycle hooks.</span></span><br><span class="line">      <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (next) &#123;</span><br><span class="line">        next.<span class="property">el</span> = vnode.<span class="property">el</span>;</span><br><span class="line">        <span class="title function_">updateComponentPreRender</span>(instance, next, optimized);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next = vnode;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// beforeUpdate hook</span></span><br><span class="line">      <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">        <span class="title function_">invokeArrayFns</span>(bu);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeBeforeUpdate</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = next.<span class="property">props</span> &amp;&amp; next.<span class="property">props</span>.<span class="property">onVnodeBeforeUpdate</span>)) &#123;</span><br><span class="line">        <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, next, vnode);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è€ƒè™‘å…¼å®¹</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        __COMPAT__ &amp;&amp;</span><br><span class="line">        <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:beforeUpdate&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// render</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> nextTree = <span class="title function_">renderComponentRoot</span>(instance);</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> prevTree = instance.<span class="property">subTree</span>;</span><br><span class="line">      instance.<span class="property">subTree</span> = nextTree;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">startMeasure</span>(instance, <span class="string">`patch`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°åˆ™æ¯”è¾ƒæ–°æ—§subTree</span></span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        prevTree,</span><br><span class="line">        nextTree,</span><br><span class="line">        <span class="comment">// parent may have changed if it&#x27;s in a teleport</span></span><br><span class="line">        <span class="title function_">hostParentNode</span>(prevTree.<span class="property">el</span>!)!,</span><br><span class="line">        <span class="comment">// anchor may have changed if it&#x27;s in a fragment</span></span><br><span class="line">        <span class="title function_">getNextHostNode</span>(prevTree),</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">endMeasure</span>(instance, <span class="string">`patch`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      next.<span class="property">el</span> = nextTree.<span class="property">el</span>;</span><br><span class="line">      <span class="keyword">if</span> (originNext === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// self-triggered update. In case of HOC, update parent component</span></span><br><span class="line">        <span class="comment">// vnode el. HOC is indicated by parent instance&#x27;s subTree pointing</span></span><br><span class="line">        <span class="comment">// to child component&#x27;s vnode</span></span><br><span class="line">        <span class="title function_">updateHOCHostEl</span>(instance, nextTree.<span class="property">el</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¤„ç†updatedé’©å­</span></span><br><span class="line">      <span class="comment">// updated hook</span></span><br><span class="line">      <span class="keyword">if</span> (u) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(u, parentSuspense);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// onVnodeUpdated</span></span><br><span class="line">      <span class="keyword">if</span> ((vnodeHook = next.<span class="property">props</span> &amp;&amp; next.<span class="property">props</span>.<span class="property">onVnodeUpdated</span>)) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">          <span class="function">() =&gt;</span> <span class="title function_">invokeVNodeHook</span>(vnodeHook!, parent, next!, vnode),</span><br><span class="line">          parentSuspense</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        __COMPAT__ &amp;&amp;</span><br><span class="line">        <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">          <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:updated&quot;</span>),</span><br><span class="line">          parentSuspense</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">        <span class="title function_">devtoolsComponentUpdated</span>(instance);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">popWarningContext</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨componentUpdateFnåˆ›å»ºeffect</span></span><br><span class="line">  <span class="comment">// create reactive effect for rendering</span></span><br><span class="line">  <span class="keyword">const</span> effect = (instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">    componentUpdateFn,</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">    instance.<span class="property">scope</span> <span class="comment">// track it in component&#x27;s effect scope</span></span><br><span class="line">  ));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">SchedulerJob</span> = (instance.<span class="property">update</span> = <span class="function">() =&gt;</span> effect.<span class="title function_">run</span>());</span><br><span class="line">  update.<span class="property">id</span> = instance.<span class="property">uid</span>;</span><br><span class="line">  <span class="comment">// allowRecurse</span></span><br><span class="line">  <span class="comment">// #1801, #2043 component render effects should allow recursive updates</span></span><br><span class="line">  <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨äºå¼€å‘è°ƒè¯•</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    effect.<span class="property">onTrack</span> = instance.<span class="property">rtc</span></span><br><span class="line">      ? <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtc</span>!, e)</span><br><span class="line">      : <span class="built_in">void</span> <span class="number">0</span>;</span><br><span class="line">    effect.<span class="property">onTrigger</span> = instance.<span class="property">rtg</span></span><br><span class="line">      ? <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtg</span>!, e)</span><br><span class="line">      : <span class="built_in">void</span> <span class="number">0</span>;</span><br><span class="line">    update.<span class="property">ownerInstance</span> = instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨ä¸€æ¬¡æ›´æ–°</span></span><br><span class="line">  <span class="title function_">update</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="8-unmount"><a href="#8-unmount" class="headerlink" title="8. unmount"></a>8. <code>unmount</code></h3><p>æ—§èŠ‚ç‚¹çš„å¸è½½é€šè¿‡<code>unmount</code>æ¥å¤„ç†ï¼Œå…¶ä¸­æ ¹æ®èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œåˆæœ‰ç€ä¸åŒçš„å‡½æ•°æ¥å®æ–½å¸è½½ã€‚</p>
<h4 id="8-1-unmount"><a href="#8-1-unmount" class="headerlink" title="8.1 unmount"></a>8.1 <code>unmount</code></h4><p>ç»è¿‡ç½®ç©º<code>ref</code>ã€åˆ¤æ–­ä¸å¤„ç†<code>KeepAlive</code>ã€<code>beforeUnmounted</code>çš„é’©å­å‡½æ•°å’ŒæŒ‡ä»¤ã€åˆ¤æ–­ç»„ä»¶çš„ç±»å‹å¹¶ç›¸åº”å¸è½½ã€å¤„ç†<code>unmounted</code>é’©å­å’ŒæŒ‡ä»¤ç­‰è¿‡ç¨‹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">unmount</span>: <span class="title class_">UnmountFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  vnode,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  doRemove = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props,</span><br><span class="line">    ref,</span><br><span class="line">    children,</span><br><span class="line">    dynamicChildren,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dirs,</span><br><span class="line">  &#125; = vnode;</span><br><span class="line">  <span class="comment">// ç½®ç©ºref</span></span><br><span class="line">  <span class="comment">// unset ref</span></span><br><span class="line">  <span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">setRef</span>(ref, <span class="literal">null</span>, parentSuspense, vnode, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»„ä»¶è¢«ç¼“å­˜ï¼Œåˆ™è°ƒç”¨&lt;KeepAlive&gt;çš„å¤±æ´»æ–¹æ³• deactivate</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span>) &#123;</span><br><span class="line">    (parentComponent!.<span class="property">ctx</span> <span class="keyword">as</span> <span class="title class_">KeepAliveContext</span>).<span class="title function_">deactivate</span>(vnode);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦è°ƒç”¨æŒ‡ä»¤å’Œé’©å­</span></span><br><span class="line">  <span class="keyword">const</span> shouldInvokeDirs = shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span> &amp;&amp; dirs;</span><br><span class="line">  <span class="keyword">const</span> shouldInvokeVnodeHook = !<span class="title function_">isAsyncWrapper</span>(vnode);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// beforeUnmounted é’©å­</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">undefined</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    shouldInvokeVnodeHook &amp;&amp;</span><br><span class="line">    (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeBeforeUnmount</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT</span>) &#123;</span><br><span class="line">    <span class="comment">// å¸è½½ç»„ä»¶</span></span><br><span class="line">    <span class="title function_">unmountComponent</span>(vnode.<span class="property">component</span>!, parentSuspense, doRemove);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¸è½½å¼‚æ­¥ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>) &#123;</span><br><span class="line">      vnode.<span class="property">suspense</span>!.<span class="title function_">unmount</span>(parentSuspense, doRemove);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æŒ‡ä»¤çš„ beforeUnmounted é˜¶æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (shouldInvokeDirs) &#123;</span><br><span class="line">      <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&quot;beforeUnmount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸è½½ Teleport</span></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>) &#123;</span><br><span class="line">      (vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">TeleportImpl</span>).<span class="title function_">remove</span>(</span><br><span class="line">        vnode,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        optimized,</span><br><span class="line">        internals,</span><br><span class="line">        doRemove</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      dynamicChildren &amp;&amp;</span><br><span class="line">      <span class="comment">// #1153: fast path should not be taken for non-stable (v-for) fragments</span></span><br><span class="line">      (<span class="keyword">type</span> !== <span class="title class_">Fragment</span> ||</span><br><span class="line">        (patchFlag &gt; <span class="number">0</span> &amp;&amp; patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">STABLE_FRAGMENT</span>))</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// å¯¹äºä¼˜åŒ–è¿‡çš„å—çŠ¶èŠ‚ç‚¹ï¼Œä»…éœ€ç§»é™¤åŠ¨æ€å­èŠ‚ç‚¹</span></span><br><span class="line">      <span class="comment">// fast path for block nodes: only need to unmount dynamic children.</span></span><br><span class="line">      <span class="title function_">unmountChildren</span>(</span><br><span class="line">        dynamicChildren,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// æ–‡æ¡£ç‰‡æ®µ  ç§»é™¤å…¶å­èŠ‚ç‚¹</span></span><br><span class="line">      (<span class="keyword">type</span> === <span class="title class_">Fragment</span> &amp;&amp;</span><br><span class="line">        patchFlag &amp;</span><br><span class="line">          (<span class="title class_">PatchFlags</span>.<span class="property">KEYED_FRAGMENT</span> | <span class="title class_">PatchFlags</span>.<span class="property">UNKEYED_FRAGMENT</span>)) ||</span><br><span class="line">      (!optimized &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">unmountChildren</span>(children <span class="keyword">as</span> <span class="title class_">VNode</span>[], parentComponent, parentSuspense);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†èŠ‚ç‚¹è‡ªèº«</span></span><br><span class="line">    <span class="keyword">if</span> (doRemove) &#123;</span><br><span class="line">      <span class="title function_">remove</span>(vnode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç† unmounted é’©å­ä»¥åŠæŒ‡ä»¤ä¸­çš„ unmounted é˜¶æ®µ</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (shouldInvokeVnodeHook &amp;&amp; (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeUnmounted</span>)) ||</span><br><span class="line">    shouldInvokeDirs</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vnodeHook &amp;&amp; <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode);</span><br><span class="line">      shouldInvokeDirs &amp;&amp;</span><br><span class="line">        <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&quot;unmounted&quot;</span>);</span><br><span class="line">    &#125;, parentSuspense);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="8-2-remove"><a href="#8-2-remove" class="headerlink" title="8.2 remove"></a>8.2 <code>remove</code></h4><p>ä½¿ç”¨<code>remove</code>æ¥ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ ¹æ®èŠ‚ç‚¹ç±»å‹ä¸ç¯å¢ƒï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿç¨æœ‰å·®åˆ«ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">remove</span>: <span class="title class_">RemoveFn</span> = <span class="function">(<span class="params">vnode</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, el, anchor, transition &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">Fragment</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      vnode.<span class="property">patchFlag</span> &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      vnode.<span class="property">patchFlag</span> &amp; <span class="title class_">PatchFlags</span>.<span class="property">DEV_ROOT_FRAGMENT</span> &amp;&amp;</span><br><span class="line">      transition &amp;&amp;</span><br><span class="line">      !transition.<span class="property">persisted</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// __DEV__ç¯å¢ƒ</span></span><br><span class="line">      <span class="comment">// éå†ç§»é™¤å­èŠ‚ç‚¹</span></span><br><span class="line">      (vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[]).<span class="title function_">forEach</span>(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (child.<span class="property">type</span> === <span class="title class_">Comment</span>) &#123;</span><br><span class="line">          <span class="title function_">hostRemove</span>(child.<span class="property">el</span>!);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">remove</span>(child);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç§»é™¤ç‰‡æ®µ</span></span><br><span class="line">      <span class="title function_">removeFragment</span>(el!, anchor!);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»é™¤é™æ€èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">Static</span>) &#123;</span><br><span class="line">    <span class="title function_">removeStaticNode</span>(vnode);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** éå†ç§»é™¤é™æ€èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">   *  const removeStaticNode = (&#123; el, anchor &#125;: VNode) =&gt; &#123;</span></span><br><span class="line"><span class="comment">   *    let next</span></span><br><span class="line"><span class="comment">   *    while (el &amp;&amp; el !== anchor) &#123;</span></span><br><span class="line"><span class="comment">   *      next = hostNextSibling(el)</span></span><br><span class="line"><span class="comment">   *      hostRemove(el)</span></span><br><span class="line"><span class="comment">   *      el = next</span></span><br><span class="line"><span class="comment">   *    &#125;</span></span><br><span class="line"><span class="comment">   *    hostRemove(anchor!)</span></span><br><span class="line"><span class="comment">   *  &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">performRemove</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ç§»é™¤el</span></span><br><span class="line">    <span class="title function_">hostRemove</span>(el!);</span><br><span class="line">    <span class="keyword">if</span> (transition &amp;&amp; !transition.<span class="property">persisted</span> &amp;&amp; transition.<span class="property">afterLeave</span>) &#123;</span><br><span class="line">      <span class="comment">// åŠ¨ç”»çš„ afterLeave é’©å­</span></span><br><span class="line">      transition.<span class="title function_">afterLeave</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    vnode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span> &amp;&amp;</span><br><span class="line">    transition &amp;&amp;</span><br><span class="line">    !transition.<span class="property">persisted</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; leave, delayLeave &#125; = transition;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">performLeave</span> = (<span class="params"></span>) =&gt; <span class="title function_">leave</span>(el!, performRemove);</span><br><span class="line">    <span class="comment">// æ¨è¿Ÿ leave åŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">if</span> (delayLeave) &#123;</span><br><span class="line">      <span class="title function_">delayLeave</span>(vnode.<span class="property">el</span>!, performRemove, performLeave);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">performLeave</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    <span class="title function_">performRemove</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="8-3-removeFragment"><a href="#8-3-removeFragment" class="headerlink" title="8.3 removeFragment"></a>8.3 <code>removeFragment</code></h4><p>ç›´æ¥éå†ç§»é™¤æ‰€æœ‰åŒ…å«çš„èŠ‚ç‚¹ï¼Œè¿™ä¸€ç‚¹ä¸ç§»é™¤é™æ€èŠ‚ç‚¹ååˆ†ç›¸ä¼¼ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">removeFragment</span> = (<span class="params">cur: RendererNode, end: RendererNode</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// For fragments, directly remove all contained DOM nodes.</span></span><br><span class="line">  <span class="comment">// (fragment child nodes cannot have transition)</span></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">while</span> (cur !== end) &#123;</span><br><span class="line">    next = <span class="title function_">hostNextSibling</span>(cur)!;</span><br><span class="line">    <span class="title function_">hostRemove</span>(cur);</span><br><span class="line">    cur = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">hostRemove</span>(end);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="8-4-unmountComponent"><a href="#8-4-unmountComponent" class="headerlink" title="8.4 unmountComponent"></a>8.4 <code>unmountComponent</code></h4><p>å¯¹äºç»„ä»¶çš„å¸è½½ï¼Œæ­¥éª¤ç¨å¾®å¤šä¸€ç‚¹ã€‚æ¯•ç«Ÿé™¤äº†è¦éå†å¸è½½å­ç»„ä»¶æ ‘ï¼Œè¦å¤„ç†ç»„ä»¶çš„é’©å­å‡½æ•°ï¼Œç”šè‡³è€ƒè™‘å¼‚æ­¥ç»„ä»¶ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">unmountComponent</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  doRemove?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; instance.<span class="property">type</span>.<span class="property">__hmrId</span>) &#123;</span><br><span class="line">    <span class="title function_">unregisterHMR</span>(instance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; bum, scope, update, subTree, um &#125; = instance;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨ beforeUnmounted é’©å­</span></span><br><span class="line">  <span class="comment">// beforeUnmount hook</span></span><br><span class="line">  <span class="keyword">if</span> (bum) &#123;</span><br><span class="line">    <span class="title function_">invokeArrayFns</span>(bum);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    __COMPAT__ &amp;&amp;</span><br><span class="line">    <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">  ) &#123;</span><br><span class="line">    instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:beforeDestroy&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœæ­¢å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="comment">// stop effects in component scope</span></span><br><span class="line">  scope.<span class="title function_">stop</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…³é—­ updateï¼Œå¸è½½å­ç»„ä»¶æ ‘</span></span><br><span class="line">  <span class="comment">// update may be null if a component is unmounted before its async</span></span><br><span class="line">  <span class="comment">// setup has resolved.</span></span><br><span class="line">  <span class="keyword">if</span> (update) &#123;</span><br><span class="line">    <span class="comment">// so that scheduler will no longer invoke it</span></span><br><span class="line">    update.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">unmount</span>(subTree, instance, parentSuspense, doRemove);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨unmountedé’©å­</span></span><br><span class="line">  <span class="comment">// unmounted hook</span></span><br><span class="line">  <span class="keyword">if</span> (um) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(um, parentSuspense);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å‘åå…¼å®¹ï¼šdestroyed é’©å­</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    __COMPAT__ &amp;&amp;</span><br><span class="line">    <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&quot;hook:destroyed&quot;</span>),</span><br><span class="line">      parentSuspense</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ›´æ”¹çŠ¶æ€ä¸ºå·²å¸è½½</span></span><br><span class="line">  <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    instance.<span class="property">isUnmounted</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;, parentSuspense);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†&lt;Suspense&gt;</span></span><br><span class="line">  <span class="comment">// A component with async dep inside a pending suspense is unmounted before</span></span><br><span class="line">  <span class="comment">// its async dep resolves. This should remove the dep from the suspense, and</span></span><br><span class="line">  <span class="comment">// cause the suspense to resolve immediately if that was the last dep.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    __FEATURE_SUSPENSE__ &amp;&amp;</span><br><span class="line">    parentSuspense &amp;&amp;</span><br><span class="line">    parentSuspense.<span class="property">pendingBranch</span> &amp;&amp;</span><br><span class="line">    !parentSuspense.<span class="property">isUnmounted</span> &amp;&amp;</span><br><span class="line">    instance.<span class="property">asyncDep</span> &amp;&amp;</span><br><span class="line">    !instance.<span class="property">asyncResolved</span> &amp;&amp;</span><br><span class="line">    instance.<span class="property">suspenseId</span> === parentSuspense.<span class="property">pendingId</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    parentSuspense.<span class="property">deps</span>--;</span><br><span class="line">    <span class="keyword">if</span> (parentSuspense.<span class="property">deps</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      parentSuspense.<span class="title function_">resolve</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    <span class="title function_">devtoolsComponentRemoved</span>(instance);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="8-5-unmountChildren"><a href="#8-5-unmountChildren" class="headerlink" title="8.5 unmountChildren"></a>8.5 <code>unmountChildren</code></h4><p>å¸è½½å­èŠ‚ç‚¹ï¼Œéå†é€’å½’<code>unmount</code>æ–¹æ³•è¿›è¡Œå¸è½½ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">unmountChildren</span>: <span class="title class_">UnmountChildrenFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  children,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">  parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">  doRemove = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  optimized = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  start = <span class="number">0</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">unmount</span>(children[i], parentComponent, parentSuspense, doRemove, optimized);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="9-å°ç»“"><a href="#9-å°ç»“" class="headerlink" title="9. å°ç»“"></a>9. å°ç»“</h3><p><code>render</code>åªæ˜¯ä¸ªå¼•å­ï¼Œç»å¤§éƒ¨åˆ†åŠŸèƒ½å¦‚èŠ‚ç‚¹æŒ‚è½½ã€èŠ‚ç‚¹æ›´æ–°éƒ½è¢«<code>patch</code>æ¶µç›–äº†ã€‚<code>diff</code>ç®—æ³•åœ¨åŒå±‚çº§è¿›è¡Œéå†æ¯”è¾ƒï¼Œæ ¸å¿ƒå†…å®¹éƒ½åœ¨<code>patchKeyedChildren</code>ä¸­ï¼Œé¦–å°¾èŠ‚ç‚¹å„è‡ªå¾ªç¯ä¸€è½®ï¼Œå¯¹äºä¸­é—´çš„èŠ‚ç‚¹ï¼Œåˆ™åˆ©ç”¨<code>Map</code>æ¥æ˜ å°„<code>key</code>å’ŒèŠ‚ç‚¹åœ¨æ–°å­èŠ‚ç‚¹ç»„ä¸­çš„<code>index</code>ï¼Œå†éå†å‰©ä½™çš„æ—§å­èŠ‚ç‚¹ç»„ï¼Œåœ¨<code>Map</code>ä¸­æ‰¾ç›¸åŒçš„<code>key</code>é‡Œç¡®å®šè¿™ä¸ªæ—§èŠ‚ç‚¹æ˜¯å¦å¯å¤ç”¨ã€‚æ²¡æœ‰<code>key</code>çš„æƒ…å†µåˆ™ä½¿ç”¨<code>patchUnkeyedChildren</code>è¿›è¡Œ<code>diff</code>ï¼Œç®€å•ç²—æš´ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://loveyy520.github.io/onlyy-blog">ChrisLeyâ„ï¸</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://loveyy520.github.io/onlyy-blog/articals/876e332/">https://loveyy520.github.io/onlyy-blog/articals/876e332/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://loveyy520.github.io/onlyy-blog" target="_blank">OnlyyğŸ¦„</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/articals/tags/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><a class="post-meta__tags" href="/articals/tags/Vue3/">Vue3</a><a class="post-meta__tags" href="/articals/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">æºç é˜…è¯»</a></div><div class="post_share"><div class="social-share" data-image="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æ‰“èµ</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://assets.onlyy.vip/qrcodes/WeChat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://assets.onlyy.vip/qrcodes/WeChat.png" alt="å¾® ä¿¡"/></a><div class="post-qr-code-desc">å¾® ä¿¡</div></li><li class="reward-item"><a href="https://asssets.onlyy.vip/qrcodes/Alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://asssets.onlyy.vip/qrcodes/Alipay.png" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://assets.akilar.top@1.0.16/audio/coin.mp3"></audio><script defer="defer" src="/"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/articals/aec8236e/"><img class="prev-cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" onerror="onerror=null;src='https://blog.onlyy.vip/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Vue3æºç ç³»åˆ—ï¼ˆä¸ƒï¼‰ï¼šcreateApp â€” ä¸€åˆ‡çš„èµ·æº</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/articals/dd689204/" title="Vue3æºç ç³»åˆ— (ä¸€) watch"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-20</div><div class="title">Vue3æºç ç³»åˆ— (ä¸€) watch</div></div></a></div><div><a href="/articals/f9a32caf/" title="Vue3æºç ç³»åˆ— (ä¸‰) reactive å’Œ readonly"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-21</div><div class="title">Vue3æºç ç³»åˆ— (ä¸‰) reactive å’Œ readonly</div></div></a></div><div><a href="/articals/16fef359/" title="Vue3æºç ç³»åˆ— (äºŒ) computed"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_winters_feast.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-21</div><div class="title">Vue3æºç ç³»åˆ— (äºŒ) computed</div></div></a></div><div><a href="/articals/9baf97c7/" title="Vue3æºç ç³»åˆ— (äº”) effectå’ŒReactiveEffect ã€ track ä¸ trigger"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-21</div><div class="title">Vue3æºç ç³»åˆ— (äº”) effectå’ŒReactiveEffect ã€ track ä¸ trigger</div></div></a></div><div><a href="/articals/e80db997/" title="Vue3æºç ç³»åˆ— (å…­) KeepAlive"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-22</div><div class="title">Vue3æºç ç³»åˆ— (å…­) KeepAlive</div></div></a></div><div><a href="/articals/f1070434/" title="Vue3æºç ç³»åˆ— (å››) ref"><img class="cover" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-21</div><div class="title">Vue3æºç ç³»åˆ— (å››) ref</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://assets.onlyy.vip/icons/dst/Willow.png" onerror="this.onerror=null;this.src='https://blog.onlyy.vip/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ChrisLeyâ„ï¸</div><div class="author-info__description">Record of life ğŸ·</div></div><div class="card-info-data site-data is-center"><a href="/articals/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">28</div></a><a href="/articals/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/articals/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/loveyy520"><i></i><span>ğŸ›´Have a look...</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/loveyy520" rel="external nofollow noreferrer" target="_blank" title="Github"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github1"></use></svg></a><a class="social-icon" href="mailto:201357337@qq.com" rel="external nofollow noreferrer" target="_blank" title="Email"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-email"></use></svg></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81render"><span class="toc-number">1.</span> <span class="toc-text">ä¸€ã€render</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81patch"><span class="toc-number">2.</span> <span class="toc-text">äºŒã€patch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-patch"><span class="toc-number">2.1.</span> <span class="toc-text">1. patch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-processText"><span class="toc-number">2.2.</span> <span class="toc-text">2. processText</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-processCommontNode"><span class="toc-number">2.3.</span> <span class="toc-text">3. processCommontNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-mountStaticNode-%E5%92%8C-patchStaticNode"><span class="toc-number">2.4.</span> <span class="toc-text">4. mountStaticNode å’Œ patchStaticNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-processFragment"><span class="toc-number">2.5.</span> <span class="toc-text">5. processFragment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-processFragment"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1 processFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-patchBlockChildren"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 patchBlockChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-patchChildren"><span class="toc-number">2.5.3.</span> <span class="toc-text">5.3 patchChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-patchKeyedChildren"><span class="toc-number">2.5.4.</span> <span class="toc-text">5.4 patchKeyedChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-patchUnkeyedChildren"><span class="toc-number">2.5.5.</span> <span class="toc-text">5.5 patchUnkeyedChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-mountChildren"><span class="toc-number">2.5.6.</span> <span class="toc-text">5.6 mountChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-unmountChildren"><span class="toc-number">2.5.7.</span> <span class="toc-text">5.7 unmountChildren</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-move"><span class="toc-number">2.5.8.</span> <span class="toc-text">5.8 move</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-processElement"><span class="toc-number">2.6.</span> <span class="toc-text">6. processElement</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-processElement"><span class="toc-number">2.6.1.</span> <span class="toc-text">6.1 processElement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-mountElement"><span class="toc-number">2.6.2.</span> <span class="toc-text">6.2 mountElement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-patchElement"><span class="toc-number">2.6.3.</span> <span class="toc-text">6.3 patchElement</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-processComponent"><span class="toc-number">2.7.</span> <span class="toc-text">7. processComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-processComponent"><span class="toc-number">2.7.1.</span> <span class="toc-text">7.1 processComponent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-mountComponent"><span class="toc-number">2.7.2.</span> <span class="toc-text">7.2 mountComponent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-updateComponent"><span class="toc-number">2.7.3.</span> <span class="toc-text">7.3 updateComponent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-updateComponentPreRender"><span class="toc-number">2.7.4.</span> <span class="toc-text">7.4 updateComponentPreRender</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-setupRenderEffect"><span class="toc-number">2.7.5.</span> <span class="toc-text">7.4 setupRenderEffect</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-unmount"><span class="toc-number">2.8.</span> <span class="toc-text">8. unmount</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-unmount"><span class="toc-number">2.8.1.</span> <span class="toc-text">8.1 unmount</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-remove"><span class="toc-number">2.8.2.</span> <span class="toc-text">8.2 remove</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-removeFragment"><span class="toc-number">2.8.3.</span> <span class="toc-text">8.3 removeFragment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-unmountComponent"><span class="toc-number">2.8.4.</span> <span class="toc-text">8.4 unmountComponent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-unmountChildren"><span class="toc-number">2.8.5.</span> <span class="toc-text">8.5 unmountChildren</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%B0%8F%E7%BB%93"><span class="toc-number">2.9.</span> <span class="toc-text">9. å°ç»“</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/articals/876e332/" title="Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff"><img src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" onerror="this.onerror=null;this.src='https://blog.onlyy.vip/img/404.jpg'" alt="Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff"/></a><div class="content"><a class="title" href="/articals/876e332/" title="Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff">Vue3æºç ç³»åˆ—ï¼ˆå…«ï¼‰ï¼šrenderä¸patch â€” äº†è§£diff</a><time datetime="2022-11-02T09:21:00.000Z" title="å‘è¡¨äº 2022-11-02 17:21:00">2022-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articals/aec8236e/" title="Vue3æºç ç³»åˆ—ï¼ˆä¸ƒï¼‰ï¼šcreateApp â€” ä¸€åˆ‡çš„èµ·æº"><img src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" onerror="this.onerror=null;this.src='https://blog.onlyy.vip/img/404.jpg'" alt="Vue3æºç ç³»åˆ—ï¼ˆä¸ƒï¼‰ï¼šcreateApp â€” ä¸€åˆ‡çš„èµ·æº"/></a><div class="content"><a class="title" href="/articals/aec8236e/" title="Vue3æºç ç³»åˆ—ï¼ˆä¸ƒï¼‰ï¼šcreateApp â€” ä¸€åˆ‡çš„èµ·æº">Vue3æºç ç³»åˆ—ï¼ˆä¸ƒï¼‰ï¼šcreateApp â€” ä¸€åˆ‡çš„èµ·æº</a><time datetime="2022-10-29T08:46:00.000Z" title="å‘è¡¨äº 2022-10-29 16:46:00">2022-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articals/e80db997/" title="Vue3æºç ç³»åˆ— (å…­) KeepAlive"><img src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" onerror="this.onerror=null;this.src='https://blog.onlyy.vip/img/404.jpg'" alt="Vue3æºç ç³»åˆ— (å…­) KeepAlive"/></a><div class="content"><a class="title" href="/articals/e80db997/" title="Vue3æºç ç³»åˆ— (å…­) KeepAlive">Vue3æºç ç³»åˆ— (å…­) KeepAlive</a><time datetime="2022-10-22T07:54:00.000Z" title="å‘è¡¨äº 2022-10-22 15:54:00">2022-10-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright"><span>&copy;2022</span><svg style="width:1.5em; height:1.5em" aria-hidden="true"><use xlink:href="#icon-Butterfly">        </use></svg><span>ChrisLeyâ„ï¸</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="èŠå¤©"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="https://blog.onlyy.vip/js/utils.js"></script><script src="https://blog.onlyy.vip/js/main.js"></script><script src="https://blog.onlyy.vip/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://blog.onlyy.vip/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'cloudbase-baas-6gxpccf2d62b75a4',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'cloudbase-baas-6gxpccf2d62b75a4',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async src="//at.alicdn.com/t/c/font_3751481_s1jp1qngav.js"></script><script src="https://assets.onlyy.vip/js/onlyy-blog/progress-bar.js"></script><script src="https://assets.onlyy.vip/js/onlyy-blog/rain.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="//code.tidio.co/lvkqkvgv02wsgqur2hv3fhlq5vvou9ng.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><a class="magnet_link_more" href="./articals/categories" style="flex:1;text-align: center;margin-bottom: 10px;" one-link-mark="yes">æ›´å¤š...</a></div></div><a class="magnet_link_more"  href="https://loveyy520.github.io/onlyy-blog/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a>undefined';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 380px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 320px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://assets.onlyy.vip/photos/);"> <a class="categoryBar-list-link" href="articals/categories/å‰ç«¯/">å‰ç«¯</a><span class="categoryBar-list-count">28</span><span class="categoryBar-list-descr">UbuntuæŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover2.webp);"> <a class="categoryBar-list-link" href="articals/categories/å‰ç«¯/JavaScript/">JavaScript</a><span class="categoryBar-list-count">6</span><span class="categoryBar-list-descr">ç©è½¬Win10</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover3.webp);"> <a class="categoryBar-list-link" href="articals/categories/å‰ç«¯/TypeScript/">TypeScript</a><span class="categoryBar-list-count">14</span><span class="categoryBar-list-descr">é•¿ç¯‡å°è¯´è¿è½½</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover4.webp);"> <a class="categoryBar-list-link" href="articals/categories/æºç /">æºç </a><span class="categoryBar-list-count">8</span><span class="categoryBar-list-descr">ä¸ªäººæ—¥è®°</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover5.webp);"> <a class="categoryBar-list-link" href="articals/categories/å‰ç«¯/Vue3/">Vue3</a><span class="categoryBar-list-count">8</span><span class="categoryBar-list-descr">è¯—è¯æ­Œèµ‹</span></li></ul></div></div>';
      console.log('å·²æŒ‚è½½butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = '/posts/,/about/'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = 'b71ecf86205a4d209cd76c784d236f7b';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/7d186aad/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-05</span><a class="blog-slider__title" href="articals/7d186aad/" alt="">Typescriptç³»åˆ— åŸºç¡€ç¯‡ (å…­) æ¨¡å—åŒ–å…¥é—¨ç¯‡</a><div class="blog-slider__text">ä½œè€…è¿˜åœ¨ç¡è§‰ï¼Œå¿˜äº†å†™æ–‡ç« æè¿°~</div><a class="blog-slider__button" href="articals/7d186aad/" alt="">è¯¦æƒ…   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/2d027281/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-03</span><a class="blog-slider__title" href="articals/2d027281/" alt="">TypeScriptç³»åˆ—åŸºç¡€ç¯‡(å››) ç±»å‹æ“çºµ</a><div class="blog-slider__text">ä½œè€…è¿˜åœ¨ç¡è§‰ï¼Œå¿˜äº†å†™æ–‡ç« æè¿°~</div><a class="blog-slider__button" href="articals/2d027281/" alt="">è¯¦æƒ…   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/e1f9072b/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-05</span><a class="blog-slider__title" href="articals/e1f9072b/" alt="">TypeScriptç³»åˆ—  åŸºç¡€ç¯‡(äº”)  Classes ç±»</a><div class="blog-slider__text">ä½œè€…è¿˜åœ¨ç¡è§‰ï¼Œå¿˜äº†å†™æ–‡ç« æè¿°~</div><a class="blog-slider__button" href="articals/e1f9072b/" alt="">è¯¦æƒ…   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/70f81d2c/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-01</span><a class="blog-slider__title" href="articals/70f81d2c/" alt="">TSç³»åˆ—åŸºç¡€ç¯‡(ä¸€) TSç±»å‹æŒ‡å—</a><div class="blog-slider__text">ä½œè€…è¿˜åœ¨ç¡è§‰ï¼Œå¿˜äº†å†™æ–‡ç« æè¿°~</div><a class="blog-slider__button" href="articals/70f81d2c/" alt="">è¯¦æƒ…   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/364db865/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-02</span><a class="blog-slider__title" href="articals/364db865/" alt="">TypeScript ç³»åˆ—åŸºç¡€ç¯‡(ä¸‰) å¯¹è±¡ç±»å‹</a><div class="blog-slider__text">ä½œè€…è¿˜åœ¨ç¡è§‰ï¼Œå¿˜äº†å†™æ–‡ç« æè¿°~</div><a class="blog-slider__button" href="articals/364db865/" alt="">è¯¦æƒ…   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="articals/2d2f991a/" alt=""><img width="48" height="48" src="https://assets.onlyy.vip/photos/dont-starve/bg_wendy_victorian.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-02</span><a class="blog-slider__title" href="articals/2d2f991a/" alt="">Typescript ç³»åˆ—åŸºç¡€ç¯‡(äºŒ) TS ä¸­çš„å‡½æ•°</a><div class="blog-slider__text">è¯¦ç»†ä»‹ç»TypeScriptä¸­çš„å‡½æ•°ã€‚</div><a class="blog-slider__button" href="articals/2d2f991a/" alt="">è¯¦æƒ…   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.2.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.5.1" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½², ä¸»çº¿è·¯æ‰˜ç®¡äºVercel" title=""><img src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="https://assets.onlyy.vip/js/onlyy-blog/footerTimer.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/https://blog.onlyy.vip/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"https://blog.onlyy.vip/live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/https://blog.onlyy.vip/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>